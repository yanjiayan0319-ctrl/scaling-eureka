<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>秋天 Phone Interface</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style id="main-style">
        [v-cloak] {
            display: none !important;
        }
        :root {
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --text-color: #333;
            --accent-color: #ff9a9e;
            --icon-size: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(45deg, #fbc2eb 0%, #a6c1ee 100%);
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            transition: background-image 0.5s ease;
            user-select: none; /* 防止长按选中文本 */
            -webkit-user-select: none;
        }

        /* 背景遮罩 */
        .bg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: -1;
        }

        #app {
            width: 100%;
            height: 100%;
        }

        /* 主屏幕容器 */
        .main-screen {
            width: 100%;
            height: 100%;
            position: relative;
            padding: 20px;
            overflow: hidden;
        }

        /* 通用胶囊/毛玻璃样式 */
        .glass-capsule {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            box-shadow: var(--glass-shadow);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease, background 0.3s;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }

        .glass-capsule:active {
            transform: scale(0.95);
        }

        /* 可拖动元素通用样式 */
        .draggable-item {
            position: absolute;
            touch-action: none; /* 关键：防止浏览器默认滚动 */
            cursor: grab;
            z-index: 10;
        }

        .draggable-item.is-dragging {
            z-index: 100 !important;
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            transition: none; /* 拖动时移除过渡 */
        }

        /* 顶部日期气泡 */
        .top-date-bubble {
            padding: 10px 25px;
            font-size: 1.1rem;
            font-weight: 500;
            color: #444;
            border-radius: 50px;
            white-space: nowrap;
        }

        /* 图标按钮样式 */
        .icon-btn {
            width: var(--icon-size);
            height: var(--icon-size);
            border-radius: 20px;
            font-size: 24px;
            color: #555;
            background-repeat: no-repeat;
        }
        
        .icon-btn i {
            z-index: 2;
        }
        
        .icon-btn.has-custom-icon i {
            display: none;
        }

        .icon-label {
            position: absolute;
            bottom: -20px;
            font-size: 12px;
            width: 100%;
            text-align: center;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        /* 左下角日历组件 */
        .calendar-widget {
            width: 220px;
            height: 160px;
            border-radius: 25px;
            flex-direction: column;
            align-items: flex-start;
            padding: 20px;
            color: #333;
        }

        .time-display {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 5px;
            letter-spacing: -2px;
        }

        .date-display {
            font-size: 1.2rem;
            font-weight: 500;
            opacity: 0.8;
        }

        .weekday-display {
            font-size: 1rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* 恋爱小组件 */
        .love-widget {
            width: 160px;
            height: 160px;
            background: transparent; 
            border: none;
            box-shadow: none;
            backdrop-filter: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .star-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            filter: drop-shadow(0 8px 16px rgba(31, 38, 135, 0.2));
        }

        .star-svg {
            position: absolute;
            width: 100%;
            height: 100%;
            fill: var(--glass-bg);
            stroke: var(--glass-border);
            stroke-width: 2;
        }
        
        .love-content {
            position: relative;
            z-index: 2;
            text-align: center;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60%;
        }

        .love-title {
            font-size: 0.8rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .love-days {
            font-size: 1.8rem;
            font-weight: bold;
            color: #e91e63;
        }

        /* 模态框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            z-index: 200; /* 高于拖动元素 */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
        }

        /* 裁剪器样式覆盖 */
        .cropper-container {
            border-radius: 10px;
            overflow: hidden;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        
        .modal-body {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
        }

        .form-control:focus {
            border-color: var(--accent-color);
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #ff7e82;
        }

        .upload-preview {
            width: 100%;
            height: 100px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 5px;
            cursor: pointer;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            color: #999;
        }
        
        .upload-preview:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .divider {
            height: 1px;
            background: #eee;
            margin: 20px 0;
        }

        .theme-manager h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #444;
        }

        .save-theme-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .saved-themes-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .theme-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f5f5f5;
        }

        .theme-item:last-child {
            border-bottom: none;
        }

        .theme-actions {
            display: flex;
            gap: 5px;
        }

        .btn-secondary {
            padding: 10px 15px;
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            background: #eee;
        }

        .btn-danger {
            background: #ff6b6b(0 42% 11%);
            color: white;
        }

        .btn-danger-outline {
            padding: 12px;
            background: transparent;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-danger-outline:hover {
            background: #ff6b6b;
            color: white;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-shrink: 0;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .modal-footer .btn-primary {
            flex: 2;
        }
        
        .modal-footer .btn-danger-outline {
            flex: 1;
        }
        
        button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .icon-upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .icon-upload-item {
            text-align: center;
        }
        
        .icon-upload-item label {
            font-size: 0.8rem;
            margin-bottom: 5px;
            display: block;
        }
        
        .mini-preview {
            width: 100%;
            height: 60px;
            border: 1px dashed #ccc;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            font-size: 0.8rem;
            color: #999;
        }
        
        .mini-preview:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* 全屏页面通用样式 */
        .full-page {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 50;
            animation: fadeIn 0.3s ease;
        }

        .nav-header {
            height: calc(60px + env(safe-area-inset-top));
            padding: 0 15px;
            padding-top: env(safe-area-inset-top);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
            z-index: 10;
        }

        .nav-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .page-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        /* 世界书菜单 */
        .world-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99;
        }

        .world-menu {
            position: absolute;
            top: calc(50px + env(safe-area-inset-top));
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 5px;
            z-index: 100;
            width: 160px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0,0,0,0.05);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .world-menu-item {
            padding: 12px 15px;
            font-size: 0.95rem;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .world-menu-item:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .world-menu-item i {
            color: var(--accent-color);
            width: 20px;
            text-align: center;
        }

        /* 世界书列表样式 */
        .world-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .world-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.2s, background 0.2s;
            cursor: pointer;
        }

        .world-item:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.8);
        }

        .world-item-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            margin-right: 15px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .world-cover {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
        }

        .world-item-info {
            flex-grow: 1;
            overflow: hidden;
        }

        .world-item-title {
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            margin-bottom: 4px;
        }

        .world-item-desc {
            font-size: 0.85rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .world-item-arrow {
            color: #999;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        @media (max-width: 768px) {
            .time-display { font-size: 2.5rem; }
        }

        /* 聊天应用样式 */
        .chat-app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }

        .chat-header {
            padding: 15px 20px;
            padding-top: calc(15px + env(safe-area-inset-top));
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            height: calc(60px + env(safe-area-inset-top));
            flex-shrink: 0;
            position: relative;
        }

        .chat-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .chat-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .chat-tab-bar {
            height: 70px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-shrink: 0;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 25%;
            height: 100%;
        }

        .tab-item.active {
            color: var(--accent-color);
        }

        .tab-item i {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        /* 消息列表项 */
        .message-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            cursor: pointer;
        }

        .message-item:active {
            transform: scale(0.98);
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            margin-right: 15px;
            border: 2px solid rgba(255,255,255,0.5);
            flex-shrink: 0;
        }

        .message-info {
            flex-grow: 1;
            overflow: hidden;
        }

        .message-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 4px;
            color: #333;
        }

        .message-preview {
            font-size: 0.9rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-time {
            font-size: 0.8rem;
            color: #999;
            margin-left: 10px;
            flex-shrink: 0;
        }

        /* 通讯录列表 */
        .contact-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .add-contact-btn {
            position: absolute;
            bottom: calc(90px + env(safe-area-inset-bottom));
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4);
            cursor: pointer;
            border: none;
            z-index: 10;
        }

        .empty-state {
            text-align: center;
            color: #666;
            margin-top: 50px;
        }

        /* 操作菜单模态框 */
        .action-menu {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border-radius: 15px;
            overflow: hidden;
            width: 80%;
            max-width: 300px;
        }

        .action-item {
            width: 100%;
            background: transparent;
            border: none;
            font-family: inherit;
            display: block;
            
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            font-size: 1rem;
            color: #333;
        }

        .action-item:last-child {
            border-bottom: none;
        }

        .action-item:active {
            background: rgba(255, 255, 255, 0.3);
        }

        .action-item.danger {
            color: #ff6b6b;
        }

        /* 聊天详情页样式 */
        .chat-detail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            display: flex;
            flex-direction: column;
        }

        .chat-bg-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(245, 245, 245, 0.9);
            background-size: cover;
            background-position: center;
            z-index: -1;
            pointer-events: none;
        }

        .chat-detail-header {
            height: calc(60px + env(safe-area-inset-top));
            padding: 0 15px;
            padding-top: env(safe-area-inset-top);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
            z-index: 10;
        }

        .chat-detail-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .chat-messages-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .message-bubble-container {
            display: flex;
            margin-bottom: 10px;
            max-width: 80%;
        }

        .message-bubble-container.self {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-bubble-container.other {
            align-self: flex-start;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            margin: 0 10px;
            flex-shrink: 0;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 1rem;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            max-width: 100%;
        }

        .message-bubble.self {
            background: var(--accent-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-bubble.other {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #333;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .message-bubble.image-bubble {
            padding: 5px;
            background: transparent !important;
            box-shadow: none;
        }

        .message-bubble.voice-bubble {
            padding: 10px 15px;
            min-width: 80px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .voice-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-icon {
            font-size: 1.1rem;
        }

        .voice-text {
            font-size: 0.85rem;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
            width: 100%;
            opacity: 0.9;
        }

        /* 照片气泡样式 */
        .message-bubble.photo-bubble {
            padding: 0;
            width: 220px;
            height: 220px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            background: #f0f0f0;
            border-radius: 10px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* 引用块样式 */
        .quote-block {
            margin-top: 6px;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            border-left: 3px solid rgba(0, 0, 0, 0.2);
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            text-align: left;
            min-width: 100px;
        }

        .quote-name {
            font-weight: bold;
            opacity: 0.8;
            font-size: 0.75rem;
            margin-bottom: 2px;
        }

        .quote-content {
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .message-bubble.self .quote-block {
            background: rgba(255, 255, 255, 0.2);
            border-left-color: rgba(255, 255, 255, 0.5);
        }

        .photo-placeholder {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-color: #e0e0e0;
            /* 默认占位图，用户可通过自定义CSS覆盖此属性 */
            background-image: url('https://api.iconify.design/fluent:image-24-regular.svg?color=%23999999');
            background-repeat: no-repeat;
            background-size: 40%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .photo-text-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            text-align: center;
            font-size: 0.95rem;
            font-weight: 500;
            overflow-y: auto;
            animation: fadeIn 0.2s;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .chat-footer {
            min-height: 70px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: flex-end;
            gap: 10px;
            flex-shrink: 0;
            position: relative;
        }

        .reply-preview {
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 10px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
            z-index: 5;
            animation: slideUp 0.2s ease-out;
        }
        
        .reply-content {
            flex-grow: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            display: flex;
            gap: 5px;
        }
        
        .reply-name {
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .close-reply-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 5px;
            font-size: 1.1rem;
        }

        .recall-notification {
            font-size: 0.85rem;
            color: #999;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 5px 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
        }

        .chat-input-wrapper {
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            min-height: 44px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .chat-input {
            width: 100%;
            border: none;
            background: transparent;
            outline: none;
            font-size: 1rem;
            resize: none;
            max-height: 100px;
            padding: 0;
            line-height: 1.4;
        }

        .chat-action-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .chat-action-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.8);
        }

        .chat-action-btn.send-btn {
            background: var(--accent-color);
            color: white;
            border: none;
        }

        /* 聊天扩展面板 */
        .chat-extras-panel {
            height: 220px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            padding: 20px;
            gap: 15px;
            flex-shrink: 0;
            animation: slideUp 0.2s ease-out;
        }

        .extra-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: #666;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .extra-icon {
            width: 55px;
            height: 55px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.1s;
        }

        .extra-item:active .extra-icon {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.8);
        }

        /* 表情包面板样式 */
        .extras-grid {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            width: 100%;
            height: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 10px 5px;
            align-items: center;
            /* 隐藏滚动条但保持功能 */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        
        .extras-grid::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }
        
        /* 确保子元素不被压缩且有合适宽度 */
        .extras-grid .extra-item {
            flex-shrink: 0;
            width: 75px; 
        }

        .emoji-panel {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .emoji-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .emoji-list {
            flex-grow: 1;
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            padding: 10px 5px;
            align-items: center;
            /* 隐藏滚动条 */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .emoji-list::-webkit-scrollbar {
            display: none;
        }

        .emoji-item {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .emoji-img {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
        }

        .emoji-desc {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 0.6rem;
            padding: 2px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-emoji-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: rgba(255,0,0,0.7);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            border: none;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .emoji-item:hover .delete-emoji-btn {
            opacity: 1;
        }

        .empty-emoji {
            grid-column: 1 / -1;
            text-align: center;
            color: #999;
            padding-top: 20px;
            font-size: 0.9rem;
        }

        @keyframes slideUp {
            from { height: 0; opacity: 0; }
            to { height: 220px; opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="bg-overlay"></div>

        <!-- 主屏幕 -->
        <div class="main-screen" ref="mainScreen" v-show="currentPage === 'home'">
            <!-- 顶部日期气泡 -->
            <div class="glass-capsule top-date-bubble draggable-item"
                 v-if="settings.visibility.dateBubble"
                 :class="{ 'is-dragging': draggingId === 'dateBubble' }"
                 :style="getLayoutStyle('dateBubble')"
                 @mousedown="startDrag($event, 'dateBubble')"
                 @touchstart="startDrag($event, 'dateBubble')">
                {{ currentDateFull }}
            </div>

            <!-- 外观设置图标 -->
            <div class="glass-capsule icon-btn draggable-item" 
                 :class="{ 'has-custom-icon': settings.icons.settings, 'is-dragging': draggingId === 'btnSettings' }"
                 :style="{ ...getIconStyle('settings'), ...getLayoutStyle('btnSettings') }"
                 @mousedown="startDrag($event, 'btnSettings')"
                 @touchstart="startDrag($event, 'btnSettings')"
                 @click="handleClick('settings')"
                 title="外观设置">
                <i class="fas fa-paint-brush"></i>
                <span class="icon-label">外观</span>
            </div>

            <!-- API设置图标 -->
            <div class="glass-capsule icon-btn draggable-item" 
                 :class="{ 'has-custom-icon': settings.icons.api, 'is-dragging': draggingId === 'btnApi' }"
                 :style="{ ...getIconStyle('api'), ...getLayoutStyle('btnApi') }"
                 @mousedown="startDrag($event, 'btnApi')"
                 @touchstart="startDrag($event, 'btnApi')"
                 @click="handleClick('api')"
                 title="API设置">
                <i class="fas fa-code"></i>
                <span class="icon-label">API</span>
            </div>

            <!-- 聊天图标 -->
            <div class="glass-capsule icon-btn draggable-item" 
                 :class="{ 'has-custom-icon': settings.icons.chat, 'is-dragging': draggingId === 'btnChat' }"
                 :style="{ ...getIconStyle('chat'), ...getLayoutStyle('btnChat') }"
                 @mousedown="startDrag($event, 'btnChat')"
                 @touchstart="startDrag($event, 'btnChat')"
                 @click="handleClick('chat')"
                 title="聊天">
                <i class="fas fa-comment-dots"></i>
                <span class="icon-label">聊天</span>
            </div>

            <!-- 世界书图标 -->
            <div class="glass-capsule icon-btn draggable-item" 
                 :class="{ 'has-custom-icon': settings.icons.world, 'is-dragging': draggingId === 'btnWorld' }"
                 :style="{ ...getIconStyle('world'), ...getLayoutStyle('btnWorld') }"
                 @mousedown="startDrag($event, 'btnWorld')"
                 @touchstart="startDrag($event, 'btnWorld')"
                 @click="handleClick('world')"
                 title="世界书">
                <i class="fas fa-book-open"></i>
                <span class="icon-label">世界书</span>
            </div>

            <!-- 左下角日历组件 -->
            <div class="glass-capsule calendar-widget draggable-item" 
                 v-if="settings.visibility.calendar"
                 :class="{ 'is-dragging': draggingId === 'calendar' }"
                 :style="{ ...calendarStyle, ...getLayoutStyle('calendar') }"
                 @mousedown="startDrag($event, 'calendar')"
                 @touchstart="startDrag($event, 'calendar')">
                <div class="time-display">{{ currentTime }}</div>
                <div class="date-display">{{ currentDateShort }}</div>
                <div class="weekday-display">{{ currentWeek }}</div>
            </div>

            <!-- 恋爱小组件 -->
            <div class="love-widget draggable-item" 
                 v-if="settings.visibility.love"
                 :class="{ 'is-dragging': draggingId === 'love' }"
                 :style="getLayoutStyle('love')"
                 @mousedown="startDrag($event, 'love')"
                 @touchstart="startDrag($event, 'love')">
                <div class="star-container">
                    <svg class="star-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <div class="love-content">
                        <div class="love-title">恋爱天数</div>
                        <div class="love-days">{{ loveDays }}</div>
                        <div class="love-title">天</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 聊天应用界面 -->
        <div class="chat-app" v-if="currentPage === 'chat'">
            <div class="chat-header">
                <button class="btn-small" @click="currentPage = 'home'">
                    <i class="fas fa-chevron-left"></i> 返回
                </button>
                <div class="chat-title">{{ chatPageTitle }}</div>
                <div style="width: 30px;"></div> <!-- 占位，保持布局平衡 -->
            </div>

            <div class="chat-content">
                <!-- 消息页面 -->
                <div v-if="chatTab === 'messages'">
                    <div v-if="contacts.length === 0" class="empty-state">
                        <p>暂无消息</p>
                        <p style="font-size: 0.8rem; margin-top: 5px;">请先在通讯录添加角色</p>
                    </div>
                    <div v-else class="message-list">
                        <div class="message-item" v-for="contact in contacts" :key="contact.id" @click="openChat(contact)">
                            <div class="avatar" :style="{ backgroundImage: `url(${contact.avatar || 'https://via.placeholder.com/50'})` }"></div>
                            <div class="message-info">
                                <div class="message-name">{{ contact.nickname || contact.name }}</div>
                                <div class="message-preview">点击开始聊天</div>
                            </div>
                            <div class="message-time">刚刚</div>
                        </div>
                    </div>
                </div>

                <!-- 通讯录页面 -->
                <div v-if="chatTab === 'contacts'">
                    <div v-if="contacts.length === 0" class="empty-state">
                        <p>通讯录为空</p>
                        <p style="font-size: 0.8rem; margin-top: 5px;">点击右下角添加角色</p>
                    </div>
                    <div class="contact-list">
                        <div class="contact-item" 
                             v-for="contact in contacts" 
                             :key="contact.id"
                             @touchstart="startContactLongPress($event, contact)"
                             @touchend="endContactLongPress"
                             @mousedown="startContactLongPress($event, contact)"
                             @mouseup="endContactLongPress"
                             @mouseleave="endContactLongPress">
                            <div class="avatar" :style="{ backgroundImage: `url(${contact.avatar || 'https://via.placeholder.com/50'})` }"></div>
                            <div class="message-name">{{ contact.nickname || contact.name }}</div>
                        </div>
                    </div>
                </div>

                <!-- 朋友圈页面 -->
                <div v-if="chatTab === 'moments'">
                    <div class="empty-state">朋友圈功能开发中...</div>
                </div>

                <!-- 我的页面 -->
                <div v-if="chatTab === 'profile'">
                    <div class="empty-state">个人中心开发中...</div>
                </div>
            </div>

            <button v-if="chatTab === 'contacts'" class="add-contact-btn" @click="openAddContactModal">
                <i class="fas fa-plus"></i>
            </button>

            <div class="chat-tab-bar">
                <div class="tab-item" :class="{ active: chatTab === 'messages' }" @click="chatTab = 'messages'">
                    <i class="fas fa-comment"></i>
                    <span>消息</span>
                </div>
                <div class="tab-item" :class="{ active: chatTab === 'contacts' }" @click="chatTab = 'contacts'">
                    <i class="fas fa-address-book"></i>
                    <span>通讯录</span>
                </div>
                <div class="tab-item" :class="{ active: chatTab === 'moments' }" @click="chatTab = 'moments'">
                    <i class="fas fa-camera-retro"></i>
                    <span>朋友圈</span>
                </div>
                <div class="tab-item" :class="{ active: chatTab === 'profile' }" @click="chatTab = 'profile'">
                    <i class="fas fa-user"></i>
                    <span>我的</span>
                </div>
            </div>

            <!-- 聊天详情页 -->
            <div class="chat-detail" v-if="currentChatContact">
                <div class="chat-bg-layer" :style="chatSettings.wallpaper ? { backgroundImage: `url(${chatSettings.wallpaper})` } : {}"></div>
                <div class="chat-detail-header">
                    <button class="btn-small" @click="closeChat">
                        <i class="fas fa-chevron-left"></i> 返回
                    </button>
                    <div class="chat-detail-title">{{ currentChatContact.nickname || currentChatContact.name }}</div>
                    <button class="btn-small" @click="showChatSettingsModal = true">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                
                <div class="chat-messages-area">
                    <div v-for="msg in (chatMessages[currentChatContact.id] || [])" :key="msg.id" 
                         class="message-bubble-container" 
                         :class="msg.isSelf ? 'self' : 'other'">
                        <div class="chat-avatar" 
                             :style="{ backgroundImage: `url(${msg.isSelf ? 'https://via.placeholder.com/50' : (currentChatContact.avatar || 'https://via.placeholder.com/50')})` }">
                        </div>
                        
                        <!-- 撤回消息显示 -->
                        <div v-if="msg.type === 'recall'" class="recall-notification" @click="toggleRecalledContent(msg)" title="点击查看撤回内容">
                            <i class="fas fa-undo"></i> 
                            <span v-if="!msg.showRecalled">{{ msg.isSelf ? '你' : (currentChatContact.nickname || currentChatContact.name) }} 撤回了一条消息</span>
                            <span v-else style="font-style: normal; color: #555;">[撤回] {{ msg.recalledText }}</span>
                        </div>

                        <!-- 正常消息气泡 -->
                        <div v-else class="message-bubble" 
                             :class="[msg.isSelf ? 'self' : 'other', msg.type === 'image' ? 'image-bubble' : '', msg.type === 'voice' ? 'voice-bubble' : '', msg.type === 'photo' ? 'photo-bubble' : '']"
                             @click="msg.type === 'voice' ? toggleVoiceText(msg) : (msg.type === 'photo' ? togglePhotoText(msg) : null)"
                             @touchstart="startMsgLongPress($event, msg)"
                             @touchend="endMsgLongPress"
                             @mousedown="startMsgLongPress($event, msg)"
                             @mouseup="endMsgLongPress"
                             @mouseleave="endMsgLongPress"
                             @contextmenu.prevent>
                            <img v-if="msg.type === 'image'" :src="msg.imageUrl" style="max-width: 150px; border-radius: 10px; display: block;">
                            <div v-else-if="msg.type === 'voice'" class="voice-content-wrapper">
                                <div class="voice-content" :style="{ flexDirection: msg.isSelf ? 'row-reverse' : 'row' }">
                                    <i class="fas fa-rss voice-icon" :style="{ transform: msg.isSelf ? 'rotate(-90deg)' : 'rotate(90deg)' }"></i>
                                    <span>{{ Math.min(60, Math.max(2, msg.text.length / 2)).toFixed(0) }}''</span>
                                </div>
                                <div v-if="msg.showText" class="voice-text">{{ msg.text }}</div>
                            </div>
                            <div v-else-if="msg.type === 'photo'" class="photo-placeholder">
                                <div v-if="msg.showText" class="photo-text-overlay">
                                    {{ msg.text }}
                                </div>
                            </div>
                            <div v-else>
                                <span>{{ msg.text }}</span>
                                <div v-if="msg.quote" class="quote-block">
                                    <div class="quote-name">{{ msg.quote.name }}:</div>
                                    <div class="quote-content">{{ msg.quote.content }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-footer">
                    <div class="reply-preview" v-if="replyingMsg">
                        <div class="reply-content">
                            <span class="reply-name">{{ replyingMsg.isSelf ? '我' : (currentChatContact.nickname || currentChatContact.name) }}:</span>
                            <span>{{ replyingMsg.type === 'image' ? '[图片]' : (replyingMsg.type === 'voice' ? '[语音]' : (replyingMsg.type === 'photo' ? '[照片]' : replyingMsg.text)) }}</span>
                        </div>
                        <button class="close-reply-btn" @click="replyingMsg = null">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="chat-action-btn" @click="toggleChatExtras">
                        <i class="fas fa-plus-circle" :style="showChatExtras ? { transform: 'rotate(45deg)', transition: 'transform 0.2s' } : { transition: 'transform 0.2s' }"></i>
                    </div>
                    <div class="chat-input-wrapper">
                        <textarea v-model="chatInputMessage" class="chat-input" rows="1" placeholder="发送消息..." @focus="showChatExtras = false"></textarea>
                    </div>
                    <button class="chat-action-btn send-btn" @click="handleSendClick">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- 扩展功能面板 -->
                <div class="chat-extras-panel" v-if="showChatExtras">
                    <input type="file" ref="albumUpload" accept="image/*" hidden @change="handleAlbumUpload">
                    <!-- 主功能网格 -->
                    <div class="extras-grid" v-if="currentExtraView === 'grid'">
                        <div class="extra-item" @click="handleExtraAction('emoji')">
                            <div class="extra-icon"><i class="fas fa-smile"></i></div>
                            <span>表情包</span>
                        </div>
                        <div class="extra-item" @click="handleExtraAction('voice')">
                            <div class="extra-icon"><i class="fas fa-microphone"></i></div>
                            <span>语音</span>
                        </div>
                        <div class="extra-item" @click="handleExtraAction('camera')">
                            <div class="extra-icon"><i class="fas fa-camera"></i></div>
                            <span>照片</span>
                        </div>
                        <div class="extra-item" @click="handleExtraAction('album')">
                            <div class="extra-icon"><i class="fas fa-image"></i></div>
                            <span>相册</span>
                        </div>
                        <div class="extra-item" @click="handleExtraAction('video')">
                            <div class="extra-icon"><i class="fas fa-video"></i></div>
                            <span>视频通话</span>
                        </div>
                    </div>

                    <!-- 表情包面板 -->
                    <div class="emoji-panel" v-if="currentExtraView === 'emoji'">
                        <div class="emoji-header">
                            <button class="btn-small" @click="currentExtraView = 'grid'">
                                <i class="fas fa-chevron-left"></i> 返回
                            </button>
                            <div style="font-size: 0.9rem; font-weight: bold;">表情包</div>
                            <div>
                                <button class="btn-small" @click="addEmojiFromUrl" title="添加网络表情" style="margin-right: 8px;">
                                    <i class="fas fa-link"></i>
                                </button>
                                <input type="file" ref="emojiUpload" accept="image/*" hidden @change="handleImageUpload($event, 'emoji')">
                                <button class="btn-small" @click="$refs.emojiUpload.click()" title="上传本地表情">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="emoji-list">
                            <div v-if="emojis.length === 0" class="empty-emoji">
                                暂无表情包，点击右上角添加
                            </div>
                            <div class="emoji-item" v-for="emoji in emojis" :key="emoji.id" @click="sendEmoji(emoji)">
                                <div class="emoji-img" :style="{ backgroundImage: `url(${emoji.url})` }"></div>
                                <div class="emoji-desc">{{ emoji.desc }}</div>
                                <button class="delete-emoji-btn" @click.stop="deleteEmoji(emoji.id)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- 聊天设置模态框 -->
        <div v-if="showChatSettingsModal" class="modal" @click.self="showChatSettingsModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">聊天设置</div>
                    <button class="close-btn" @click="showChatSettingsModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>聊天壁纸</label>
                        <input type="file" ref="chatBgUpload" accept="image/*" hidden @change="handleImageUpload($event, 'chat-bg')">
                        <div class="upload-preview" @click="$refs.chatBgUpload.click()" :style="chatSettings.wallpaper ? { backgroundImage: `url(${chatSettings.wallpaper})` } : {}">
                            <span v-if="!chatSettings.wallpaper">点击上传壁纸</span>
                        </div>
                        <button v-if="chatSettings.wallpaper" class="btn-small btn-danger" style="margin-top: 5px; width: 100%;" @click="chatSettings.wallpaper = ''">清除壁纸</button>
                    </div>
                    <div class="form-group">
                        <label>挂载条数 (Context Limit)</label>
                        <input type="number" v-model.number="chatSettings.contextLimit" class="form-control" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>记忆条数 (Memory Limit)</label>
                        <input type="number" v-model.number="chatSettings.memoryLimit" class="form-control" min="1" max="100">
                    </div>
                    <div class="form-group" style="display: none;">
                        <label>单条消息句数限制 (分段发送)</label>
                        <input type="number" v-model.number="chatSettings.replySplitCount" class="form-control" min="1" max="20" placeholder="默认 1 句">
                        <small style="color: #999;">AI 回复超过指定句数时将自动拆分为多条消息发送</small>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                        <label style="margin-bottom: 0;">启用记忆总结</label>
                        <input type="checkbox" v-model="chatSettings.enableSummary" style="width: 20px; height: 20px;">
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                        <label style="margin-bottom: 0;">启用动作描写 (用括号包裹)</label>
                        <input type="checkbox" v-model="chatSettings.enableActionDescription" style="width: 20px; height: 20px;">
                    </div>
                    <button v-if="chatSettings.enableSummary" class="btn-secondary" style="width: 100%; margin-top: 10px;" @click="showSummarySettingsModal = true">
                        <i class="fas fa-brain"></i> 设置记忆总结
                    </button>
                    <div class="divider"></div>
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label style="margin-bottom: 0;">自定义 CSS</label>
                            <button class="btn-small" @click="pullDefaultCss" style="font-size: 0.7rem; padding: 2px 8px;">拉取默认模板</button>
                        </div>
                        <textarea v-model="chatSettings.customCss" class="form-control" rows="6" placeholder="输入 CSS 代码以自定义聊天界面样式..." style="font-family: monospace; font-size: 0.8rem; white-space: pre; overflow-x: auto;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" @click="saveChatSettings">保存设置</button>
                </div>
            </div>
        </div>

        <!-- 记忆总结设置模态框 -->
        <div v-if="showSummarySettingsModal" class="modal" @click.self="showSummarySettingsModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">记忆总结设置</div>
                    <button class="close-btn" @click="showSummarySettingsModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>自动总结阈值 (条数)</label>
                        <input type="number" v-model.number="chatSettings.autoSummaryThreshold" class="form-control" min="5" max="100">
                        <small style="color: #999;">每当对话达到此数量时触发自动总结</small>
                    </div>
                    <div class="form-group">
                        <label>总结提示词 (Prompt)</label>
                        <textarea v-model="chatSettings.summaryPrompt" class="form-control" rows="3" placeholder="输入指导AI进行总结的提示词..."></textarea>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="form-group">
                        <label>手动总结 (指定楼层范围)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" v-model.number="manualSummaryRange.start" class="form-control" placeholder="开始">
                            <span>至</span>
                            <input type="number" v-model.number="manualSummaryRange.end" class="form-control" placeholder="结束">
                        </div>
                        <button class="btn-primary" style="margin-top: 10px;" @click="performManualSummary" :disabled="isSummarizing">
                            {{ isSummarizing ? '总结中...' : '开始总结' }}
                        </button>
                    </div>

                    <div class="divider"></div>

                    <div class="form-group">
                        <label>已生成的总结</label>
                        <div v-if="summaryRecords.length === 0" style="text-align: center; color: #999; padding: 20px;">暂无总结记录</div>
                        <div v-else style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px;">
                            <div v-for="record in summaryRecords" :key="record.id" style="padding: 10px; border-bottom: 1px solid #eee;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-weight: bold; font-size: 0.8rem;">{{ record.range }}</span>
                                    <span style="font-size: 0.7rem; color: #999;">{{ record.time }}</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #555; white-space: pre-wrap;">{{ record.content }}</div>
                                <button class="btn-small btn-danger" style="margin-top: 5px; width: 100%;" @click="deleteSummary(record.id)">删除</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" @click="showSummarySettingsModal = false">关闭</button>
                </div>
            </div>
        </div>

        <!-- 添加/编辑角色模态框 -->
        <div v-if="showAddContactModal" class="modal" @click.self="showAddContactModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">{{ editingContactId ? '编辑角色' : '添加角色' }}</div>
                    <button class="close-btn" @click="showAddContactModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>角色头像</label>
                        <input type="file" ref="contactAvatarUpload" accept="image/*" hidden @change="handleImageUpload($event, 'contact-avatar')">
                        <div class="upload-preview" @click="$refs.contactAvatarUpload.click()" :style="newContact.avatar ? { backgroundImage: `url(${newContact.avatar})` } : {}">
                            <span v-if="!newContact.avatar">点击上传头像</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>角色名字 (Prompt用)</label>
                        <input type="text" v-model="newContact.name" class="form-control" placeholder="输入角色名字">
                    </div>
                    <div class="form-group">
                        <label>角色昵称 (显示用)</label>
                        <input type="text" v-model="newContact.nickname" class="form-control" placeholder="输入角色昵称（可选）">
                    </div>
                    <div class="form-group">
                        <label>人设设定</label>
                        <textarea v-model="newContact.persona" class="form-control" rows="5" placeholder="输入角色的人设、性格、背景故事等...（AI将根据此设定进行扮演）" style="resize: none;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" @click="saveContact">{{ editingContactId ? '保存修改' : '添加' }}</button>
                </div>
            </div>
        </div>

        <!-- 操作菜单模态框 -->
        <div v-if="showActionModal" class="modal" @click.self="showActionModal = false">
            <div class="action-menu">
                <button class="action-item" @click="editContact">编辑角色</button>
                <button class="action-item danger" @click="deleteContact">删除角色</button>
                <button class="action-item" @click="showActionModal = false" style="border-top: 5px solid rgba(0,0,0,0.05); color: #999;">取消</button>
            </div>
        </div>

        <!-- 消息操作菜单模态框 -->
        <div v-if="showMsgActionModal" class="modal" @click.self="showMsgActionModal = false">
            <div class="action-menu">
                <button v-if="selectedMsg && !selectedMsg.isSelf" class="action-item" @click="handleMsgAction('regenerate')">重回 (Regenerate)</button>
                <button v-if="selectedMsg" class="action-item" @click="handleMsgAction('edit')">编辑 (Edit)</button>
                <button v-if="selectedMsg" class="action-item" @click="handleMsgAction('quote')">引用 (Quote)</button>
                <button v-if="selectedMsg && selectedMsg.isSelf" class="action-item" @click="handleMsgAction('recall')">撤回 (Recall)</button>
                <button class="action-item danger" @click="handleMsgAction('delete')">删除 (Delete)</button>
                <button class="action-item" @click="showMsgActionModal = false" style="border-top: 5px solid rgba(0,0,0,0.05); color: #999;">取消</button>
            </div>
        </div>

        <!-- 编辑消息模态框 -->
        <div v-if="showEditMsgModal" class="modal" @click.self="showEditMsgModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">编辑消息</div>
                    <button class="close-btn" @click="showEditMsgModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>消息内容</label>
                        <textarea v-model="editMsgInputText" class="form-control" rows="5" placeholder="编辑消息内容..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" @click="handleSaveEditedMsg">保存修改</button>
                </div>
            </div>
        </div>

        <!-- 外观设置页面 -->
        <div class="full-page" v-if="currentPage === 'settings'">
            <div class="nav-header">
                <button class="btn-small" @click="currentPage = 'home'">
                    <i class="fas fa-chevron-left"></i> 返回
                </button>
                <div class="nav-title">外观设置</div>
                <div style="width: 30px;"></div>
            </div>
            
            <div class="page-content">
                <div class="form-group">
                    <label>恋爱开始日期</label>
                    <input type="date" v-model="tempSettings.loveStartDate" class="form-control">
                </div>
                <div class="form-group">
                    <label>主屏幕壁纸</label>
                    <input type="file" ref="bgUpload" accept="image/*" hidden @change="handleImageUpload($event, 'body-bg')">
                    <div class="upload-preview" @click="$refs.bgUpload.click()" :style="previewBodyBgStyle">
                        <span v-if="!tempSettings.bodyBg">点击上传壁纸</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>日历组件背景</label>
                    <input type="file" ref="calendarBgUpload" accept="image/*" hidden @change="handleImageUpload($event, 'calendar-bg')">
                    <div class="upload-preview" @click="$refs.calendarBgUpload.click()" :style="previewCalendarBgStyle">
                        <span v-if="!tempSettings.calendarBg">点击上传图片</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>自定义图标</label>
                    <div class="icon-upload-grid">
                        <div class="icon-upload-item">
                            <label>外观图标</label>
                            <input type="file" ref="iconSettingsUpload" accept="image/*" hidden @change="handleImageUpload($event, 'icon-settings')">
                            <div class="mini-preview" @click="$refs.iconSettingsUpload.click()" :style="getIconPreviewStyle('settings')">
                                    <span v-if="!tempSettings.icons.settings">上传</span>
                            </div>
                        </div>
                        <div class="icon-upload-item">
                            <label>API图标</label>
                            <input type="file" ref="iconApiUpload" accept="image/*" hidden @change="handleImageUpload($event, 'icon-api')">
                            <div class="mini-preview" @click="$refs.iconApiUpload.click()" :style="getIconPreviewStyle('api')">
                                <span v-if="!tempSettings.icons.api">上传</span>
                            </div>
                        </div>
                        <div class="icon-upload-item">
                            <label>聊天图标</label>
                            <input type="file" ref="iconChatUpload" accept="image/*" hidden @change="handleImageUpload($event, 'icon-chat')">
                            <div class="mini-preview" @click="$refs.iconChatUpload.click()" :style="getIconPreviewStyle('chat')">
                                <span v-if="!tempSettings.icons.chat">上传</span>
                            </div>
                        </div>
                        <div class="icon-upload-item">
                            <label>世界书图标</label>
                            <input type="file" ref="iconWorldUpload" accept="image/*" hidden @change="handleImageUpload($event, 'icon-world')">
                            <div class="mini-preview" @click="$refs.iconWorldUpload.click()" :style="getIconPreviewStyle('world')">
                                <span v-if="!tempSettings.icons.world">上传</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label>组件显示管理</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 10px;">
                            <span>日期气泡</span>
                            <input type="checkbox" v-model="tempSettings.visibility.dateBubble" style="width: 20px; height: 20px;">
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 10px;">
                            <span>日历组件</span>
                            <input type="checkbox" v-model="tempSettings.visibility.calendar" style="width: 20px; height: 20px;">
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 10px;">
                            <span>恋爱组件</span>
                            <input type="checkbox" v-model="tempSettings.visibility.love" style="width: 20px; height: 20px;">
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label>布局管理</label>
                    <button class="btn-secondary" style="width: 100%" @click="resetLayout">重置所有组件位置</button>
                </div>
                
                <div class="divider"></div>
                
                <div class="theme-manager">
                    <h3>主题管理</h3>
                    <div class="save-theme-group">
                        <input type="text" v-model="newThemeName" placeholder="输入主题名称" class="form-control">
                        <button class="btn-secondary" @click="saveCurrentTheme">保存当前</button>
                    </div>
                    
                    <div class="saved-themes-list" v-if="savedThemes.length > 0">
                        <div class="theme-item" v-for="(theme, index) in savedThemes" :key="index">
                            <span>{{ theme.name }}</span>
                            <div class="theme-actions">
                                <button class="btn-small" @click="applyTheme(theme)">应用</button>
                                <button class="btn-small btn-danger" @click="removeTheme(index)">&times;</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <label style="margin-bottom: 0;">全局 CSS 编辑</label>
                        <button class="btn-small" @click="pullGlobalCss">拉取代码</button>
                    </div>
                    <textarea v-model="tempSettings.customGlobalCss" class="form-control" rows="8" placeholder="在此处修改全局 CSS..." style="font-family: monospace; white-space: pre; overflow-x: auto; font-size: 0.8rem;"></textarea>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn-primary" @click="saveSettings" type="button" style="width: 100%;">保存设置</button>
                </div>
            </div>
        </div>

        <!-- API设置页面 -->
        <div class="full-page" v-if="currentPage === 'api'">
            <div class="nav-header">
                <button class="btn-small" @click="currentPage = 'home'">
                    <i class="fas fa-chevron-left"></i> 返回
                </button>
                <div class="nav-title">API 设置</div>
                <div style="width: 30px;"></div>
            </div>
            <div class="page-content">
                <div class="form-group">
                    <label>API Endpoint</label>
                    <input type="text" v-model="api.endpoint" class="form-control" placeholder="https://api.openai.com/v1">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" v-model="api.key" class="form-control" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label>模型名称</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" v-model="api.model" class="form-control" placeholder="gpt-3.5-turbo" list="model-list">
                        <button class="btn-secondary" @click="fetchModels" :disabled="isLoadingModels" style="white-space: nowrap;">
                            <i class="fas fa-sync-alt" :class="{ 'fa-spin': isLoadingModels }"></i>
                            {{ isLoadingModels ? '...' : '拉取' }}
                        </button>
                    </div>
                    <datalist id="model-list">
                        <option v-for="model in availableModels" :key="model" :value="model"></option>
                    </datalist>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn-primary" @click="saveApiSettings">保存配置</button>
                </div>
            </div>
        </div>

        <!-- 世界书页面 -->
        <div class="full-page" v-if="currentPage === 'world'">
            <div class="nav-header">
                <button class="btn-small" @click="handleWorldBack">
                    <i class="fas fa-chevron-left"></i> 返回
                </button>
                <div class="nav-title">{{ currentWorldFolderName || '世界书' }}</div>
                <button class="btn-small" @click="showWorldMenu = !showWorldMenu">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <!-- 右上角菜单 -->
            <div class="world-menu-overlay" v-if="showWorldMenu" @click="showWorldMenu = false"></div>
            <div class="world-menu" v-if="showWorldMenu">
                <div class="world-menu-item" @click="addWorldBook">
                    <i class="fas fa-book"></i> 添加世界书
                </div>
                <div class="world-menu-item" @click="addWorldGroup">
                    <i class="fas fa-folder-plus"></i> 添加分组
                </div>
            </div>

            <div class="page-content">
                <div v-if="currentWorldItems.length === 0" class="empty-state">
                    <p>暂无内容</p>
                    <p style="font-size: 0.8rem; margin-top: 5px;">点击右上角添加</p>
                </div>
                <div class="world-list" v-else>
                    <div class="world-item" v-for="item in currentWorldItems" :key="item.id" 
                         @click="handleWorldItemClick(item)"
                         @touchstart="startWorldItemLongPress($event, item)"
                         @touchend="endWorldItemLongPress"
                         @mousedown="startWorldItemLongPress($event, item)"
                         @mouseup="endWorldItemLongPress"
                         @mouseleave="endWorldItemLongPress">
                        <div class="world-item-icon">
                            <div v-if="item.cover" class="world-cover" :style="{ backgroundImage: `url(${item.cover})` }"></div>
                            <i v-else :class="item.type === 'group' ? 'fas fa-folder' : 'fas fa-book'" :style="{ color: item.type === 'group' ? '#ffd700' : 'var(--accent-color)' }"></i>
                        </div>
                        <div class="world-item-info">
                            <div class="world-item-title">{{ item.title }}</div>
                            <div class="world-item-desc">{{ item.description || '暂无描述' }}</div>
                        </div>
                        <div class="world-item-arrow" v-if="item.type === 'group'">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加/编辑世界书模态框 -->
        <div v-if="showAddWorldModal" class="modal" @click.self="showAddWorldModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">{{ newWorldItem.id ? '编辑' : '添加' }}{{ newWorldItem.type === 'group' ? '分组' : '世界书' }}</div>
                    <button class="close-btn" @click="showAddWorldModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>封面图片</label>
                        <input type="file" ref="worldCoverUpload" accept="image/*" hidden @change="handleImageUpload($event, 'world-cover')">
                        <div class="upload-preview" @click="$refs.worldCoverUpload.click()" :style="newWorldItem.cover ? { backgroundImage: `url(${newWorldItem.cover})` } : {}">
                            <span v-if="!newWorldItem.cover">点击上传封面</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>标题</label>
                        <input type="text" v-model="newWorldItem.title" class="form-control" :placeholder="newWorldItem.type === 'group' ? '分组名称' : '世界书标题'">
                    </div>
                    <div class="form-group">
                        <label>描述</label>
                        <textarea v-model="newWorldItem.description" class="form-control" rows="3" placeholder="简短描述..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" @click="saveWorldItem">保存</button>
                </div>
            </div>
        </div>

        <!-- 世界书操作菜单模态框 -->
        <div v-if="showWorldActionModal" class="modal" @click.self="showWorldActionModal = false">
            <div class="action-menu">
                <button class="action-item" @click="editWorldItem">编辑</button>
                <button class="action-item danger" @click="deleteWorldItem">删除</button>
                <button class="action-item" @click="showWorldActionModal = false" style="border-top: 5px solid rgba(0,0,0,0.05); color: #999;">取消</button>
            </div>
        </div>

        <!-- 语音输入模态框 -->
        <div v-if="showVoiceModal" class="modal" @click.self="showVoiceModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">发送语音</div>
                    <button class="close-btn" @click="showVoiceModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>输入文字（将转换为语音消息）</label>
                        <textarea v-model="voiceInputText" class="form-control" rows="5" placeholder="在此输入文字..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" @click="handleSendVoice">发送语音</button>
                </div>
            </div>
        </div>

        <!-- 照片输入模态框 -->
        <div v-if="showPhotoModal" class="modal" @click.self="showPhotoModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">发送照片</div>
                    <button class="close-btn" @click="showPhotoModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>照片描述</label>
                        <textarea v-model="photoInputText" class="form-control" rows="5" placeholder="描述这张照片..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" @click="handleSendPhoto">发送照片</button>
                </div>
            </div>
        </div>

        <!-- 裁剪模态框 -->
        <div v-if="showCropperModal" class="modal" style="z-index: 300; display: none;" :style="{ display: 'flex', zIndex: 300 }">
            <div class="modal-content" style="height: 80vh; max-width: 600px;">
                <div class="modal-header">
                    <div class="modal-title">裁剪图片</div>
                    <button class="close-btn" @click="cancelCrop">&times;</button>
                </div>
                <div class="modal-body" style="overflow: hidden; display: flex; justify-content: center; align-items: center; background: #f0f0f0; border-radius: 10px;">
                    <div style="max-width: 100%; max-height: 100%;">
                        <img ref="cropperImg" :src="cropperImgSrc" style="max-width: 100%; display: block; opacity: 0;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-danger-outline" @click="cancelCrop">取消</button>
                    <button class="btn-primary" @click="confirmCrop">确认裁剪</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, reactive, nextTick } = Vue;

        createApp({
            setup() {
                // 状态
                const now = ref(new Date());
                // const showSettingsModal = ref(false); // 已废弃
                // const showApiModal = ref(false); // 已废弃
                const showCropperModal = ref(false);
                const showWorldMenu = ref(false);
                const worldList = ref([]);
                const currentWorldFolderId = ref(null);
                const showAddWorldModal = ref(false);
                const showWorldActionModal = ref(false);
                const newWorldItem = ref({
                    id: null,
                    title: '',
                    type: 'book',
                    parentId: null,
                    cover: '',
                    description: ''
                });
                const selectedWorldItem = ref(null);
                let worldItemLongPressTimer = null;

                const showAddContactModal = ref(false);
                const showActionModal = ref(false);
                const mainScreen = ref(null);
                
                // 页面导航状态
                const currentPage = ref('home'); // 'home' or 'chat'
                const chatTab = ref('messages'); // 'messages', 'contacts', 'moments', 'profile'
                
                // 通讯录数据
                const contacts = ref([]);
                const newContact = ref({
                    name: '',
                    nickname: '',
                    avatar: '',
                    persona: ''
                });
                const editingContactId = ref(null);
                const selectedContact = ref(null);
                let contactLongPressTimer = null;

                // 聊天详情页状态
                const currentChatContact = ref(null);
                const chatInputMessage = ref('');
                const showChatExtras = ref(false);
                const currentExtraView = ref('grid'); // 'grid' | 'emoji'
                const showVoiceModal = ref(false);
                const voiceInputText = ref('');
                const showPhotoModal = ref(false);
                const photoInputText = ref('');
                const albumUpload = ref(null);
                const emojis = ref([]);
                const showChatSettingsModal = ref(false);
                const chatMessages = ref({}); // 格式: { contactId: [{ id, text, isSelf, time }] }
                
                // 消息操作相关状态
                const showMsgActionModal = ref(false);
                const showEditMsgModal = ref(false);
                const editMsgInputText = ref('');
                const selectedMsg = ref(null);
                const replyingMsg = ref(null);
                let msgLongPressTimer = null;

                const chatSettings = ref({
                    wallpaper: '',
                    contextLimit: 10, // 挂载条数
                    memoryLimit: 20,  // 记忆条数
                    enableSummary: true, // 记忆总结
                    enableActionDescription: true, // 动作描写开关
                    customCss: '', // 自定义CSS
                    autoSummaryThreshold: 20, // 自动总结阈值
                    summaryPrompt: '请总结以上对话的主要内容，包含关键事件和情感变化。', // 总结提示词
                    replySplitCount: 1 // 分段句数
                });

                const showSummarySettingsModal = ref(false);
                const summaryRecords = ref([]);
                const manualSummaryRange = ref({ start: 1, end: 10 });
                const isSummarizing = ref(false);

                const defaultCssTemplate = `/* 自定义聊天样式示例 */
/* 修改自己消息气泡颜色 */
.message-bubble.self {
    background: #ff9a9e;
    color: white;
}

/* 修改对方消息气泡颜色 */
.message-bubble.other {
    background: white;
    color: #333;
}

/* 修改聊天背景层透明度 */
.chat-bg-layer {
    opacity: 0.8;
}`;

                const applyCustomCss = (css) => {
                    let styleTag = document.getElementById('custom-chat-css');
                    if (!styleTag) {
                        styleTag = document.createElement('style');
                        styleTag.id = 'custom-chat-css';
                        document.head.appendChild(styleTag);
                    }
                    styleTag.textContent = css || '';
                };

                const removeCustomCss = () => {
                    const styleTag = document.getElementById('custom-chat-css');
                    if (styleTag) {
                        styleTag.textContent = '';
                    }
                };

                const pullDefaultCss = () => {
                    if (chatSettings.value.customCss && !confirm('这将覆盖当前的自定义 CSS，确定吗？')) {
                        return;
                    }
                    chatSettings.value.customCss = defaultCssTemplate;
                };

                // 裁剪相关状态
                const cropperImgSrc = ref('');
                const cropperImg = ref(null);
                let cropperInstance = null;
                let currentUploadType = '';
                
                const settings = ref({
                    loveStartDate: '2026-01-01',
                    bodyBg: '',
                    calendarBg: '',
                    icons: {
                        settings: '',
                        api: '',
                        chat: '',
                        world: ''
                    },
                    visibility: {
                        dateBubble: true,
                        calendar: true,
                        love: true,
                        btnSettings: true,
                        btnApi: true,
                        btnChat: true,
                        btnWorld: true
                    },
                    customGlobalCss: ''
                });

                // 临时设置对象，用于设置页面的编辑状态
                const tempSettings = ref(JSON.parse(JSON.stringify(settings.value)));

                const initTempSettings = () => {
                    tempSettings.value = JSON.parse(JSON.stringify(settings.value));
                };

                const api = ref({
                    endpoint: '',
                    key: '',
                    model: ''
                });

                // 新增 API 状态
                const availableModels = ref([]);
                const isLoadingModels = ref(false);

                const savedThemes = ref([]);
                const newThemeName = ref('');

                // 布局状态
                const layout = reactive({});
                const draggingId = ref(null);
                const dragOffset = reactive({ x: 0, y: 0 });
                let longPressTimer = null;
                let isDragging = false;

                // 默认布局
                const defaultLayout = {
                    dateBubble: { left: '50%', top: '10%', transform: 'translateX(-50%)' },
                    calendar: { left: '40px', top: 'auto', bottom: '80px' },
                    love: { left: '280px', top: 'auto', bottom: '80px' },
                    btnSettings: { left: '30px', top: '40%' },
                    btnApi: { left: '30px', top: '55%' },
                    btnChat: { left: 'auto', right: '30px', top: '35%' },
                    btnWorld: { left: 'auto', right: '30px', top: '50%' }
                };

                // 定时器
                let timer = null;

                // 计算属性
                const currentTime = computed(() => {
                    const hours = String(now.value.getHours()).padStart(2, '0');
                    const minutes = String(now.value.getMinutes()).padStart(2, '0');
                    return `${hours}:${minutes}`;
                });

                const currentDateShort = computed(() => {
                    const month = now.value.getMonth() + 1;
                    const date = now.value.getDate();
                    return `${month}月${date}日`;
                });

                const currentWeek = computed(() => {
                    const weeks = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
                    return weeks[now.value.getDay()];
                });

                const currentDateFull = computed(() => {
                    const year = now.value.getFullYear();
                    const month = String(now.value.getMonth() + 1).padStart(2, '0');
                    const date = String(now.value.getDate()).padStart(2, '0');
                    return `${year}年${month}月${date}日`;
                });

                const chatPageTitle = computed(() => {
                    const titles = {
                        'messages': '消息',
                        'contacts': '通讯录',
                        'moments': '朋友圈',
                        'profile': '我的'
                    };
                    return titles[chatTab.value];
                });

                const loveDays = computed(() => {
                    if (!settings.value.loveStartDate) return 0;
                    const start = new Date(settings.value.loveStartDate);
                    const diffTime = Math.abs(now.value - start);
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                });

                const calendarStyle = computed(() => {
                    const style = {};
                    if (settings.value.calendarBg) {
                        style.backgroundImage = `url(${settings.value.calendarBg})`;
                        style.textShadow = '0 1px 3px rgba(255,255,255,0.8)';
                    }
                    return style;
                });

                const previewBodyBgStyle = computed(() => {
                    return tempSettings.value.bodyBg ? { backgroundImage: `url(${tempSettings.value.bodyBg})` } : {};
                });

                const previewCalendarBgStyle = computed(() => {
                    return tempSettings.value.calendarBg ? { backgroundImage: `url(${tempSettings.value.calendarBg})` } : {};
                });

                const currentWorldItems = computed(() => {
                    return worldList.value.filter(item => item.parentId === currentWorldFolderId.value);
                });

                const currentWorldFolderName = computed(() => {
                    if (!currentWorldFolderId.value) return '世界书';
                    const folder = worldList.value.find(item => item.id === currentWorldFolderId.value);
                    return folder ? folder.title : '世界书';
                });

                // 拖动逻辑
                const getLayoutStyle = (id) => {
                    if (layout[id]) {
                        return {
                            left: layout[id].left,
                            top: layout[id].top,
                            bottom: layout[id].bottom || 'auto',
                            right: layout[id].right || 'auto',
                            transform: layout[id].transform || 'none'
                        };
                    }
                    return defaultLayout[id] || {};
                };

                const startDrag = (event, id) => {
                    // 如果是点击事件，不阻止默认行为（允许点击）
                    // 只有长按才会触发拖动
                    isDragging = false;
                    
                    const touch = event.touches ? event.touches[0] : event;
                    
                    // 设置长按定时器
                    longPressTimer = setTimeout(() => {
                        isDragging = true;
                        draggingId.value = id;
                        
                        // 计算偏移量
                        const el = event.target.closest('.draggable-item');
                        const rect = el.getBoundingClientRect();
                        dragOffset.x = touch.clientX - rect.left;
                        dragOffset.y = touch.clientY - rect.top;
                        
                        // 震动反馈 (如果支持)
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, 500); // 500ms 长按触发
                };

                const handleMove = (event) => {
                    if (!isDragging || !draggingId.value) {
                        // 如果移动了，清除长按定时器
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                        return;
                    }
                    
                    event.preventDefault(); // 防止滚动
                    const touch = event.touches ? event.touches[0] : event;
                    
                    // 计算新位置 (相对于 main-screen)
                    const screenRect = mainScreen.value.getBoundingClientRect();
                    let newLeft = touch.clientX - screenRect.left - dragOffset.x;
                    let newTop = touch.clientY - screenRect.top - dragOffset.y;
                    
                    // 更新布局
                    layout[draggingId.value] = {
                        left: newLeft + 'px',
                        top: newTop + 'px',
                        bottom: 'auto',
                        right: 'auto',
                        transform: 'none' // 拖动后移除 transform 居中
                    };
                };

                const endDrag = () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    
                    if (isDragging) {
                        isDragging = false;
                        draggingId.value = null;
                        saveLayout();
                    }
                };

                const handleClick = (type) => {
                    if (!isDragging) {
                        // 所有主要功能现在都跳转到全屏页面
                        if (['chat', 'settings', 'api', 'world'].includes(type)) {
                            if (type === 'settings') {
                                initTempSettings();
                            }
                            currentPage.value = type;
                        }
                    }
                };

                const openAddContactModal = () => {
                    editingContactId.value = null;
                    newContact.value = { name: '', nickname: '', avatar: '', persona: '' };
                    showAddContactModal.value = true;
                };

                const saveContact = () => {
                    if (!newContact.value.name) {
                        alert('请输入角色名字');
                        return;
                    }
                    
                    if (editingContactId.value) {
                        // 编辑模式
                        const index = contacts.value.findIndex(c => c.id === editingContactId.value);
                        if (index !== -1) {
                            contacts.value[index] = {
                                ...contacts.value[index],
                                name: newContact.value.name,
                                nickname: newContact.value.nickname,
                                avatar: newContact.value.avatar,
                                persona: newContact.value.persona
                            };
                        }
                    } else {
                        // 添加模式
                        contacts.value.push({
                            id: Date.now(),
                            name: newContact.value.name,
                            nickname: newContact.value.nickname,
                            avatar: newContact.value.avatar,
                            persona: newContact.value.persona
                        });
                    }
                    
                    localStorage.setItem('contacts', JSON.stringify(contacts.value));
                    
                    // 重置表单
                    newContact.value = { name: '', nickname: '', avatar: '', persona: '' };
                    showAddContactModal.value = false;
                    editingContactId.value = null;
                    
                    // 如果是添加模式，切换到消息页查看
                    if (!editingContactId.value) {
                        chatTab.value = 'messages';
                    }
                };

                // 通讯录长按逻辑
                const startContactLongPress = (event, contact) => {
                    // 只有左键点击才触发 (0)
                    if (event.type === 'mousedown' && event.button !== 0) return;
                    
                    selectedContact.value = contact;
                    contactLongPressTimer = setTimeout(() => {
                        showActionModal.value = true;
                        // 震动反馈
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, 500);
                };

                const endContactLongPress = () => {
                    if (contactLongPressTimer) {
                        clearTimeout(contactLongPressTimer);
                        contactLongPressTimer = null;
                    }
                };

                // 消息长按逻辑
                const startMsgLongPress = (event, msg) => {
                    if (event.type === 'mousedown' && event.button !== 0) return;
                    
                    // 防止在滚动时触发
                    isDragging = false;
                    
                    msgLongPressTimer = setTimeout(() => {
                        selectedMsg.value = msg;
                        showMsgActionModal.value = true;
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, 500);
                };

                const endMsgLongPress = () => {
                    if (msgLongPressTimer) {
                        clearTimeout(msgLongPressTimer);
                        msgLongPressTimer = null;
                    }
                };

                const handleMsgAction = (action) => {
                    if (!selectedMsg.value || !currentChatContact.value) return;
                    const contactId = currentChatContact.value.id;
                    const msgs = chatMessages.value[contactId];
                    
                    if (action === 'delete') {
                        if (confirm('确定删除这条消息吗？')) {
                            chatMessages.value[contactId] = msgs.filter(m => m.id !== selectedMsg.value.id);
                            localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                            // 如果删除的是最后一条，可能需要更新一些状态，这里暂不处理
                        }
                    } else if (action === 'recall') {
                        // 撤回：标记为 recall 类型
                        const msg = msgs.find(m => m.id === selectedMsg.value.id);
                        if (msg) {
                            msg.type = 'recall';
                            msg.recalledText = msg.text; // 保留原文本以备查（可选）
                            msg.text = '[撤回了一条消息]'; // 显示文本更新
                            localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                        }
                    } else if (action === 'edit') {
                        editMsgInputText.value = selectedMsg.value.text;
                        showEditMsgModal.value = true;
                        showMsgActionModal.value = false;
                        return; // 提前返回，保留 selectedMsg
                    } else if (action === 'quote') {
                        replyingMsg.value = selectedMsg.value;
                        // 聚焦输入框
                        nextTick(() => {
                            const input = document.querySelector('.chat-input');
                            if (input) input.focus();
                        });
                    } else if (action === 'regenerate') {
                        // 重回：删除该消息及之后的所有消息，然后重新触发 AI
                        const index = msgs.findIndex(m => m.id === selectedMsg.value.id);
                        if (index !== -1) {
                            // 删除从该消息开始的所有消息
                            // 注意：通常重回是指重新生成 AI 的回复。
                            // 如果选中的是 AI 消息，我们删除它，并把之前的历史作为上下文重新请求。
                            // 如果选中的是用户消息，通常不叫重回，或者是指让 AI 重新回复这条用户消息。
                            // 这里实现为：删除选中的 AI 消息，并重新调用 API 回复上一条用户消息。
                            
                            // 实际上，Regenerate 通常是针对 AI 的最后一条回复。
                            // 如果用户长按的是中间某条 AI 消息，重回意味着删除该条及之后所有，并重新生成。
                            
                            if (confirm('确定要重回吗？这将删除此消息及之后的所有对话。')) {
                                chatMessages.value[contactId] = msgs.slice(0, index);
                                localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                                
                                // 触发 AI 回复
                                // 获取当前最新的消息历史作为上下文
                                const history = chatMessages.value[contactId];
                                if (history.length > 0) {
                                    // 重新调用 API
                                    const limit = chatSettings.value.contextLimit || 10;
                                    const historyMsgs = history.slice(-limit);
                                    
                                    const apiMessages = historyMsgs.map(m => {
                                        let content = m.text;
                                        
                                        // 处理引用消息
                                        if (m.quote) {
                                            content = `「引用 ${m.quote.name}: ${m.quote.content}」\n${content}`;
                                        }

                                        if (m.type === 'recall') {
                                            content = `[${m.isSelf ? '用户' : '你'}撤回了一条消息]`;
                                        } else if (m.type === 'image' || m.type === 'photo') {
                                            content = `[发送了一张图片]`;
                                        } else if (m.type === 'voice') {
                                            content = `[发送了一条语音: ${m.text}]`;
                                        }

                                        if (m.isEdited) {
                                            content += ' (系统提示：用户修改了此消息)';
                                        }

                                        return {
                                            role: m.isSelf ? 'user' : 'assistant',
                                            content: content
                                        };
                                    });
                                    
                                    const contact = currentChatContact.value;
                                    let systemPrompt = `你正在扮演一个角色。\n名字：${contact.name}\n昵称：${contact.nickname || contact.name}\n人设：${contact.persona || '无'}\n\n请沉浸在角色中进行对话，不要暴露你是AI。`;
                                    
                    // 动态追加动作描写指令
                    if (chatSettings.value.enableActionDescription) {
                        systemPrompt += '\n请在回复中包含动作描写，并用()包裹。';
                    } else {
                        systemPrompt += '\n请只输出对话内容，不要包含动作描写。';
                    }

                    // 特殊功能指令
                    systemPrompt += '\n\n【特殊功能】\n若要发送特殊内容，请单独发送一条消息（不要与普通文本混合），格式如下：\n- 语音：[voice:语音内容]\n- 照片：[photo:照片描述]\n- 表情包：[emoji:表情关键词]';

                    const messages = [
                                        { role: 'system', content: systemPrompt },
                                        ...apiMessages
                                    ];

                                    callLlmApi(messages, contactId);
                                }
                            }
                        }
                    }
                    
                    showMsgActionModal.value = false;
                    selectedMsg.value = null;
                };

                const handleSaveEditedMsg = () => {
                    if (!selectedMsg.value || !currentChatContact.value) return;
                    const contactId = currentChatContact.value.id;
                    const msgs = chatMessages.value[contactId];
                    const msg = msgs.find(m => m.id === selectedMsg.value.id);
                    if (msg) {
                        msg.text = editMsgInputText.value;
                        // 如果编辑的是对方的消息，标记为已编辑
                        if (!msg.isSelf) {
                            msg.isEdited = true;
                        }
                        localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                    }
                    showEditMsgModal.value = false;
                    selectedMsg.value = null;
                };

                const toggleRecalledContent = (msg) => {
                    if (msg.recalledText) {
                        msg.showRecalled = !msg.showRecalled;
                    }
                };

                const editContact = () => {
                    if (!selectedContact.value) return;
                    editingContactId.value = selectedContact.value.id;
                    newContact.value = { ...selectedContact.value };
                    showActionModal.value = false;
                    showAddContactModal.value = true;
                };

                const deleteContact = () => {
                    if (!selectedContact.value) return;
                    if (confirm(`确定要删除角色 "${selectedContact.value.name}" 吗？这将同时删除相关会话。`)) {
                        const contactId = selectedContact.value.id;
                        contacts.value = contacts.value.filter(c => c.id !== contactId);
                        localStorage.setItem('contacts', JSON.stringify(contacts.value));
                        
                        // 同时删除聊天记录
                        if (chatMessages.value[contactId]) {
                            delete chatMessages.value[contactId];
                            localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                        }
                        
                        // 删除聊天设置和壁纸
                        localStorage.removeItem(`chatSettings_${contactId}`);
                        localStorage.removeItem(`img_chat_bg_${contactId}`);
                    }
                    showActionModal.value = false;
                };

                // 聊天相关方法
                const openChat = (contact) => {
                    currentChatContact.value = contact;
                    // 加载该角色的聊天设置
                    const savedSettings = localStorage.getItem(`chatSettings_${contact.id}`);
                    let settings = {};
                    
                    if (savedSettings) {
                        try {
                            settings = JSON.parse(savedSettings);
                        } catch (e) {
                            console.error('解析聊天设置失败', e);
                        }
                    }
                    
                    // 合并设置，优先使用保存的设置，否则使用默认值
                    chatSettings.value = {
                        contextLimit: 10,
                        memoryLimit: 20,
                        enableSummary: true,
                        enableActionDescription: true,
                        customCss: '',
                        autoSummaryThreshold: 20,
                        summaryPrompt: '请总结以上对话的主要内容，包含关键事件和情感变化。',
                        replySplitCount: 1,
                        ...settings,
                        wallpaper: '' // 先置空，后面单独加载
                    };

                    // 加载总结记录
                    const savedSummaries = localStorage.getItem(`summaryRecords_${contact.id}`);
                    summaryRecords.value = savedSummaries ? JSON.parse(savedSummaries) : [];
                    
                    // 初始化手动总结范围建议
                    const msgCount = (chatMessages.value[contact.id] || []).length;
                    manualSummaryRange.value = { 
                        start: Math.max(1, msgCount - 19), 
                        end: Math.max(1, msgCount) 
                    };
                    
                    // 单独加载壁纸
                    const savedWallpaper = localStorage.getItem(`img_chat_bg_${contact.id}`);
                    if (savedWallpaper) {
                        chatSettings.value.wallpaper = savedWallpaper;
                    }

                    // 应用自定义 CSS
                    if (chatSettings.value.customCss) {
                        applyCustomCss(chatSettings.value.customCss);
                    }
                    
                    // 滚动到底部
                    nextTick(() => {
                        scrollToBottom();
                    });
                };

                const closeChat = () => {
                    currentChatContact.value = null;
                    chatInputMessage.value = '';
                    showChatExtras.value = false;
                    removeCustomCss();
                };

                const toggleChatExtras = () => {
                    showChatExtras.value = !showChatExtras.value;
                    if (showChatExtras.value) {
                        currentExtraView.value = 'grid';
                        nextTick(() => scrollToBottom());
                    }
                };

                const handleExtraAction = (type) => {
                    if (type === 'emoji') {
                        currentExtraView.value = 'emoji';
                        return;
                    }
                    if (type === 'voice') {
                        voiceInputText.value = '';
                        showVoiceModal.value = true;
                        showChatExtras.value = false;
                        return;
                    }
                    if (type === 'camera') {
                        photoInputText.value = '';
                        showPhotoModal.value = true;
                        showChatExtras.value = false;
                        return;
                    }

                    if (type === 'album') {
                        nextTick(() => {
                            if (albumUpload.value) {
                                albumUpload.value.click();
                            }
                        });
                        return;
                    }
                    
                    if (type === 'video') {
                        alert('视频通话功能开发中...');
                    }
                };

                const handleAlbumUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file || !currentChatContact.value) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const result = e.target.result;
                        const contactId = currentChatContact.value.id;
                        
                        if (!chatMessages.value[contactId]) {
                            chatMessages.value[contactId] = [];
                        }

                        chatMessages.value[contactId].push({
                            id: Date.now(),
                            text: '图片消息',
                            imageUrl: result,
                            type: 'image',
                            isSelf: true,
                            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                        });

                        localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                        
                        // 重置 input
                        event.target.value = '';
                        showChatExtras.value = false; // 发送后关闭面板
                        
                        checkAutoSummary(contactId);
                        nextTick(() => scrollToBottom());
                    };
                    reader.readAsDataURL(file);
                };

                const handleSendPhoto = () => {
                    if (!currentChatContact.value) return;
                    
                    const contactId = currentChatContact.value.id;
                    if (!chatMessages.value[contactId]) {
                        chatMessages.value[contactId] = [];
                    }
                    
                    chatMessages.value[contactId].push({
                        id: Date.now(),
                        text: photoInputText.value || '照片描述',
                        type: 'photo',
                        showText: false,
                        isSelf: true,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    });
                    
                    localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                    
                    photoInputText.value = '';
                    showPhotoModal.value = false;
                    
                    checkAutoSummary(contactId);
                    nextTick(() => scrollToBottom());
                };

                const togglePhotoText = (msg) => {
                    if (msg.type === 'photo') {
                        msg.showText = !msg.showText;
                    }
                };

                const handleSendVoice = () => {
                    if (!voiceInputText.value.trim() || !currentChatContact.value) return;
                    
                    const contactId = currentChatContact.value.id;
                    if (!chatMessages.value[contactId]) {
                        chatMessages.value[contactId] = [];
                    }
                    
                    chatMessages.value[contactId].push({
                        id: Date.now(),
                        text: voiceInputText.value,
                        type: 'voice',
                        showText: false,
                        isSelf: true,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    });
                    
                    localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                    
                    voiceInputText.value = '';
                    showVoiceModal.value = false;
                    
                    checkAutoSummary(contactId);
                    nextTick(() => scrollToBottom());
                };

                const saveEmojis = () => {
                    try {
                        localStorage.setItem('emojis', JSON.stringify(emojis.value));
                    } catch (e) {
                        alert('保存表情包失败：存储空间不足');
                    }
                };

                const addEmojiFromUrl = () => {
                    const input = prompt('请输入表情包信息，格式为 "描述:URL" 或直接输入 URL');
                    if (!input) return;

                    let url = input.trim();
                    let desc = '表情包';

                    // 尝试解析 描述:URL (支持中英文冒号)
                    const match = input.match(/^([^:：]+)[:：](.+)$/);
                    if (match) {
                        desc = match[1].trim();
                        url = match[2].trim();
                    }

                    if (!url) return;

                    emojis.value.push({
                        id: Date.now(),
                        url: url,
                        desc: desc
                    });
                    saveEmojis();
                };

                const deleteEmoji = (id) => {
                    if (!confirm('确定删除这个表情包吗？')) return;
                    emojis.value = emojis.value.filter(e => e.id !== id);
                    saveEmojis();
                };

                const sendEmoji = (emoji) => {
                    if (!currentChatContact.value) return;
                    
                    const contactId = currentChatContact.value.id;
                    if (!chatMessages.value[contactId]) {
                        chatMessages.value[contactId] = [];
                    }
                    
                    chatMessages.value[contactId].push({
                        id: Date.now(),
                        text: emoji.desc || '表情包',
                        imageUrl: emoji.url,
                        type: 'image',
                        isSelf: true,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    });
                    
                    localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                    nextTick(() => scrollToBottom());
                    
                    // 也可以触发自动总结检查
                    checkAutoSummary(contactId);
                };

                const toggleVoiceText = (msg) => {
                    if (msg.type === 'voice') {
                        msg.showText = !msg.showText;
                        // 保存状态更改（可选，如果希望刷新后保持展开状态）
                        localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                    }
                };

                const scrollToBottom = () => {
                    const container = document.querySelector('.chat-messages-area');
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                };

                // 解析 AI 特殊指令消息
                const parseAiMessageInstruction = (msg) => {
                    if (!msg || !msg.text) return;
                    
                    const text = msg.text.trim();
                    // 匹配 [type:content] 格式，支持 voice, photo, emoji
                    // 兼容中英文冒号
                    const match = text.match(/^\[(voice|photo|emoji)[:：](.*?)\]$/);
                    
                    if (match) {
                        const type = match[1];
                        const content = match[2];
                        
                        if (type === 'voice') {
                            msg.type = 'voice';
                            msg.text = content;
                            msg.showText = false;
                        } else if (type === 'photo') {
                            msg.type = 'photo';
                            msg.text = content;
                            msg.showText = false;
                        } else if (type === 'emoji') {
                            // 尝试匹配表情包
                            let targetEmoji = emojis.value.find(e => e.desc === content);
                            
                            // 模糊匹配
                            if (!targetEmoji) {
                                targetEmoji = emojis.value.find(e => e.desc.includes(content) || content.includes(e.desc));
                            }
                            
                            // 随机回退
                            if (!targetEmoji && emojis.value.length > 0) {
                                targetEmoji = emojis.value[Math.floor(Math.random() * emojis.value.length)];
                            }
                            
                            if (targetEmoji) {
                                msg.type = 'image';
                                msg.imageUrl = targetEmoji.url;
                                msg.text = content; // 保留描述文本
                            }
                        }
                    }
                };

                // API 调用相关
                const callLlmApi = async (messages, contactId) => {
                    if (!api.value.endpoint || !api.value.key) {
                        alert('请先在设置中配置 API Endpoint 和 Key');
                        return;
                    }

                        // 获取分段阈值，默认为 1
                        const splitThreshold = chatSettings.value.replySplitCount || 1;

                    // 创建第一个 AI 消息
                    let currentAiMsgId = Date.now();
                    if (!chatMessages.value[contactId]) chatMessages.value[contactId] = [];
                    
                    let currentAiMsg = {
                        id: currentAiMsgId,
                        text: '...', // 初始占位符
                        isSelf: false,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    };
                    chatMessages.value[contactId].push(currentAiMsg);
                    nextTick(() => scrollToBottom());

                    try {
                        // 处理 endpoint 结尾的斜杠
                        let endpoint = api.value.endpoint.trim();
                        if (endpoint.endsWith('/')) endpoint = endpoint.slice(0, -1);
                        // 如果用户只填了 base url (如 https://api.openai.com/v1)，则追加 /chat/completions
                        // 如果用户填了完整的 (如 .../chat/completions)，则不追加
                        if (!endpoint.endsWith('/chat/completions')) {
                            endpoint += '/chat/completions';
                        }

                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${api.value.key}`
                            },
                            body: JSON.stringify({
                                model: api.value.model || 'gpt-3.5-turbo',
                                messages: messages,
                                stream: true
                            })
                        });

                        if (!response.ok) {
                            const errText = await response.text();
                            throw new Error(`API Error ${response.status}: ${errText}`);
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder('utf-8');
                        
                        currentAiMsg.text = ''; // 清空占位符
                        
                        let buffer = ''; // 用于累积当前消息的文本
                        let pendingNewMessage = false; // 是否等待创建新消息
                        // 正则匹配句末标点：。！？；!?; 以及换行符
                        const sentenceEndRegex = /([。！？；!?;]|\n+)/g;

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            const chunk = decoder.decode(value, { stream: true });
                            const lines = chunk.split('\n');
                            
                            for (const line of lines) {
                                const trimmedLine = line.trim();
                                if (trimmedLine.startsWith('data: ') && trimmedLine !== 'data: [DONE]') {
                                    try {
                                        const data = JSON.parse(trimmedLine.slice(6));
                                        const content = data.choices[0]?.delta?.content || '';
                                        
                                        if (content) {
                                            if (pendingNewMessage) {
                                                buffer += content;
                                                if (buffer.trim().length > 0) {
                                                    const textToStart = buffer.trimStart();
                                                    currentAiMsgId = Date.now();
                                                    currentAiMsg = {
                                                        id: currentAiMsgId,
                                                        text: textToStart,
                                                        isSelf: false,
                                                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                                                    };
                                                    chatMessages.value[contactId].push(currentAiMsg);
                                                    buffer = textToStart;
                                                    pendingNewMessage = false;
                                                } else {
                                                    continue;
                                                }
                                            } else {
                                                currentAiMsg.text += content;
                                                buffer += content;
                                            }

                                            // 检测句子数量
                                            let count = 0;
                                            let splitIndex = -1;
                                            
                                            // 特殊指令处理逻辑：如果以 [ 开头，且是支持的指令，则按 ] 分段
                                            const trimmedBuffer = buffer.trimStart();
                                            if (trimmedBuffer.startsWith('[')) {
                                                // 检查是否是支持的指令类型开头
                                                if (/^\[(voice|photo|emoji)[:：]/.test(trimmedBuffer)) {
                                                    const openBracketIndex = buffer.indexOf('[');
                                                    const closeBracketIndex = buffer.indexOf(']', openBracketIndex);
                                                    
                                                    if (closeBracketIndex !== -1) {
                                                        // 在 ] 后面分段
                                                        splitIndex = closeBracketIndex + 1;
                                                    } else {
                                                        // 等待指令闭合
                                                        splitIndex = -1;
                                                    }
                                                } else {
                                                    // 普通文本分段逻辑
                                                    let match;
                                                    sentenceEndRegex.lastIndex = 0;
                                                    while ((match = sentenceEndRegex.exec(buffer)) !== null) {
                                                        count++;
                                                        if (count === splitThreshold) {
                                                            splitIndex = match.index + match[0].length;
                                                            break;
                                                        }
                                                    }
                                                }
                                            } else {
                                                // 普通文本分段逻辑
                                                let match;
                                                sentenceEndRegex.lastIndex = 0;
                                                while ((match = sentenceEndRegex.exec(buffer)) !== null) {
                                                    count++;
                                                    if (count === splitThreshold) {
                                                        splitIndex = match.index + match[0].length;
                                                        break;
                                                    }
                                                }
                                            }

                                            if (splitIndex !== -1) {
                                                const currentText = buffer.substring(0, splitIndex);
                                                const remainingText = buffer.substring(splitIndex);
                                                
                                                currentAiMsg.text = currentText;
                                                parseAiMessageInstruction(currentAiMsg); // 解析指令

                                                buffer = remainingText;
                                                
                                                if (buffer.trim().length > 0) {
                                                    const textToStart = buffer.trimStart();
                                                    currentAiMsgId = Date.now();
                                                    currentAiMsg = {
                                                        id: currentAiMsgId,
                                                        text: textToStart,
                                                        isSelf: false,
                                                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                                                    };
                                                    chatMessages.value[contactId].push(currentAiMsg);
                                                    buffer = textToStart;
                                                    pendingNewMessage = false;
                                                } else {
                                                    pendingNewMessage = true;
                                                }
                                                
                                                nextTick(() => scrollToBottom());
                                            }
                                            
                                            // 实时滚动
                                            const container = document.querySelector('.chat-messages-area');
                                            if (container && container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
                                                container.scrollTop = container.scrollHeight;
                                            }
                                        }
                                    } catch (e) {
                                        // 忽略解析错误
                                    }
                                }
                            }
                        }
                        
                        // 清理最后可能产生的空消息
                        if (currentAiMsg && !currentAiMsg.text.trim()) {
                            chatMessages.value[contactId].pop();
                        } else if (currentAiMsg) {
                            parseAiMessageInstruction(currentAiMsg); // 解析最后一条消息
                        }

                        // 完成后保存
                        localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                        checkAutoSummary(contactId);

                    } catch (error) {
                        console.error('API Call Failed:', error);
                        currentAiMsg.text += ` [API 错误: ${error.message}]`;
                        localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                    }
                };

                // 拉取模型列表
                const fetchModels = async () => {
                    if (!api.value.endpoint) {
                        alert('请先填写 API Endpoint');
                        return;
                    }
                    
                    isLoadingModels.value = true;
                    try {
                        let endpoint = api.value.endpoint.trim();
                        if (endpoint.endsWith('/')) endpoint = endpoint.slice(0, -1);
                        // 移除可能存在的 /chat/completions 后缀以获取 base url
                        endpoint = endpoint.replace(/\/chat\/completions$/, '');
                        
                        // 尝试请求 /models
                        const url = `${endpoint}/models`;
                        
                        const response = await fetch(url, {
                            headers: {
                                'Authorization': `Bearer ${api.value.key}`
                            }
                        });
                        
                        if (!response.ok) throw new Error('获取模型失败');
                        
                        const data = await response.json();
                        if (data.data && Array.isArray(data.data)) {
                            availableModels.value = data.data.map(m => m.id).sort();
                            alert(`成功获取 ${availableModels.value.length} 个模型`);
                        } else {
                            throw new Error('返回数据格式不正确');
                        }
                    } catch (e) {
                        alert('拉取模型失败: ' + e.message);
                    } finally {
                        isLoadingModels.value = false;
                    }
                };

                // 发送按钮点击处理
                const sendBtnClickCount = ref(0);
                let sendBtnTimer = null;

                const triggerAiReply = () => {
                    if (!currentChatContact.value) return;
                    const contactId = currentChatContact.value.id;

                    // 准备上下文
                    const limit = chatSettings.value.contextLimit || 10;
                    const allMsgs = chatMessages.value[contactId] || [];
                    if (allMsgs.length === 0) return;

                    const historyMsgs = allMsgs.slice(-limit);
                    
                    const history = historyMsgs.map(m => {
                        let content = m.text;

                        // 处理引用消息
                        if (m.quote) {
                            content = `「引用 ${m.quote.name}: ${m.quote.content}」\n${content}`;
                        }

                        // 处理特殊消息类型在 Prompt 中的表现
                        if (m.type === 'recall') {
                            content = `[${m.isSelf ? '用户' : '你'}撤回了一条消息]`;
                        } else if (m.type === 'image' || m.type === 'photo') {
                            content = `[发送了一张图片]`;
                        } else if (m.type === 'voice') {
                            content = `[发送了一条语音: ${m.text}]`;
                        }
                        
                        if (m.isEdited) {
                            content += ' (系统提示：用户修改了此消息)';
                        }

                        return {
                            role: m.isSelf ? 'user' : 'assistant',
                            content: content
                        };
                    });
                    
                    // 构建 System Prompt
                    const contact = currentChatContact.value;
                    let systemPrompt = `你正在扮演一个角色。\n名字：${contact.name}\n昵称：${contact.nickname || contact.name}\n人设：${contact.persona || '无'}\n\n请沉浸在角色中进行对话，不要暴露你是AI。`;
                    
                                    // 动态追加动作描写指令
                                    if (chatSettings.value.enableActionDescription) {
                                        systemPrompt += '\n请在回复中包含动作描写，并用()包裹。';
                                    } else {
                                        systemPrompt += '\n请只输出对话内容，不要包含动作描写。';
                                    }

                                    // 特殊功能指令
                                    systemPrompt += '\n\n【特殊功能】\n若要发送特殊内容，请单独发送一条消息（不要与普通文本混合），格式如下：\n- 语音：[voice:语音内容]\n- 照片：[photo:照片描述]\n- 表情包：[emoji:表情关键词]';

                                    const messages = [
                        { role: 'system', content: systemPrompt },
                        ...history
                    ];

                    callLlmApi(messages, contactId);
                };

                const handleSendClick = () => {
                    sendBtnClickCount.value++;
                    if (sendBtnClickCount.value === 1) {
                        sendBtnTimer = setTimeout(() => {
                            if (chatInputMessage.value.trim()) {
                                sendMessage(false); // 单击且有内容：发送
                            }
                            sendBtnClickCount.value = 0;
                        }, 300);
                    } else {
                        clearTimeout(sendBtnTimer);
                        if (chatInputMessage.value.trim()) {
                            sendMessage(true); // 双击且有内容：发送并回复
                        } else {
                            triggerAiReply(); // 双击且无内容：仅触发回复
                        }
                        sendBtnClickCount.value = 0;
                    }
                };

                const sendMessage = (needReply = false) => {
                    if (!chatInputMessage.value.trim() || !currentChatContact.value) return;
                    
                    const contactId = currentChatContact.value.id;
                    if (!chatMessages.value[contactId]) {
                        chatMessages.value[contactId] = [];
                    }
                    
                    // 添加用户消息
                    let userText = chatInputMessage.value;
                    
                    // 处理引用
                    let quoteData = null;
                    if (replyingMsg.value) {
                        const quotedContent = replyingMsg.value.type === 'image' ? '[图片]' : 
                                            (replyingMsg.value.type === 'voice' ? `[语音: ${replyingMsg.value.text}]` : 
                                            (replyingMsg.value.type === 'photo' ? `[照片: ${replyingMsg.value.text}]` : replyingMsg.value.text));
                        
                        quoteData = {
                            name: replyingMsg.value.isSelf ? '我' : (currentChatContact.value.nickname || currentChatContact.value.name),
                            content: quotedContent
                        };
                        replyingMsg.value = null; // 清除引用状态
                    }

                    const newMessage = {
                        id: Date.now(),
                        text: userText,
                        quote: quoteData,
                        isSelf: true,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    };

                    chatMessages.value[contactId].push(newMessage);
                    
                    chatInputMessage.value = '';
                    
                    // 保存消息
                    localStorage.setItem('chatMessages', JSON.stringify(chatMessages.value));
                    
                    // 检查自动总结
                    checkAutoSummary(contactId);

                    nextTick(() => {
                        scrollToBottom();
                    });

                    if (needReply) {
                        triggerAiReply();
                    }
                };

                const saveChatSettings = () => {
                    if (!currentChatContact.value) return;
                    
                    const contactId = currentChatContact.value.id;
                    
                    // 分离壁纸和其他设置
                    const settingsToSave = {
                        contextLimit: chatSettings.value.contextLimit,
                        memoryLimit: chatSettings.value.memoryLimit,
                        enableSummary: chatSettings.value.enableSummary,
                        enableActionDescription: chatSettings.value.enableActionDescription,
                        customCss: chatSettings.value.customCss,
                        autoSummaryThreshold: chatSettings.value.autoSummaryThreshold,
                        summaryPrompt: chatSettings.value.summaryPrompt,
                        replySplitCount: chatSettings.value.replySplitCount
                    };
                    
                    try {
                        // 保存基本设置
                        localStorage.setItem(`chatSettings_${contactId}`, JSON.stringify(settingsToSave));
                        
                        // 单独保存壁纸
                        if (chatSettings.value.wallpaper) {
                            localStorage.setItem(`img_chat_bg_${contactId}`, chatSettings.value.wallpaper);
                        } else {
                            localStorage.removeItem(`img_chat_bg_${contactId}`);
                        }

                        // 立即应用 CSS
                        applyCustomCss(chatSettings.value.customCss);
                        
                        showChatSettingsModal.value = false;
                    } catch (e) {
                        console.error('保存聊天设置失败', e);
                        if (e.name === 'QuotaExceededError' || e.code === 22) {
                            alert('保存失败：存储空间不足。图片可能太大，请尝试裁剪更小的区域。');
                        } else {
                            alert('保存设置时出错：' + e.message);
                        }
                    }
                };

                const saveLayout = () => {
                    localStorage.setItem('customLayout', JSON.stringify(layout));
                };

                const resetLayout = () => {
                    if(!confirm('确定要重置所有组件的位置吗？')) return;
                    Object.keys(layout).forEach(key => delete layout[key]);
                    localStorage.removeItem('customLayout');
                };

                // 记忆总结相关方法 - 真实调用
                const generateAiSummary = async (messages, prompt) => {
                    if (!api.value.endpoint || !api.value.key) {
                        throw new Error('API 未配置');
                    }
                    
                    let endpoint = api.value.endpoint.trim();
                    if (endpoint.endsWith('/')) endpoint = endpoint.slice(0, -1);
                    if (!endpoint.endsWith('/chat/completions')) {
                        endpoint += '/chat/completions';
                    }

                    const content = messages.map(m => `${m.isSelf ? '用户' : '角色'}: ${m.text}`).join('\n');
                    const summaryPrompt = `${prompt}\n\n以下是对话内容：\n${content}`;

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${api.value.key}`
                        },
                        body: JSON.stringify({
                            model: api.value.model || 'gpt-3.5-turbo',
                            messages: [
                                { role: 'system', content: '你是一个乐于助人的助手，擅长总结对话。' },
                                { role: 'user', content: summaryPrompt }
                            ],
                            stream: false
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.choices[0]?.message?.content || '总结失败：无内容';
                };

                const performManualSummary = async () => {
                    if (!currentChatContact.value) return;
                    const contactId = currentChatContact.value.id;
                    const msgs = chatMessages.value[contactId] || [];
                    
                    const start = parseInt(manualSummaryRange.value.start);
                    const end = parseInt(manualSummaryRange.value.end);
                    
                    if (isNaN(start) || isNaN(end) || start < 1 || end > msgs.length || start > end) {
                        alert(`无效的楼层范围。当前共有 ${msgs.length} 条消息。`);
                        return;
                    }
                    
                    // 转换为数组索引 (0-based)
                    const targetMessages = msgs.slice(start - 1, end);
                    
                    isSummarizing.value = true;
                    try {
                        const summaryText = await generateAiSummary(targetMessages, chatSettings.value.summaryPrompt);
                        
                        summaryRecords.value.unshift({
                            id: Date.now(),
                            range: `${start}-${end}`,
                            content: summaryText,
                            time: new Date().toLocaleString()
                        });
                        
                        localStorage.setItem(`summaryRecords_${contactId}`, JSON.stringify(summaryRecords.value));
                    } catch (e) {
                        alert('总结失败: ' + e.message);
                    } finally {
                        isSummarizing.value = false;
                    }
                };

                const checkAutoSummary = async (contactId) => {
                    if (!chatSettings.value.enableSummary) return;
                    
                    const msgs = chatMessages.value[contactId] || [];
                    const threshold = chatSettings.value.autoSummaryThreshold;
                    
                    // 简单逻辑：每满 threshold 条触发一次
                    if (msgs.length > 0 && msgs.length % threshold === 0) {
                        const start = Math.max(1, msgs.length - threshold + 1);
                        const end = msgs.length;
                        const targetMessages = msgs.slice(-threshold);
                        
                        try {
                            // 这里不显示 loading，后台执行
                            const summaryText = await generateAiSummary(targetMessages, chatSettings.value.summaryPrompt);
                            
                            // 读取最新记录（防止覆盖）
                            const currentRecords = JSON.parse(localStorage.getItem(`summaryRecords_${contactId}`) || '[]');
                            currentRecords.unshift({
                                id: Date.now(),
                                range: `${start}-${end} (自动)`,
                                content: summaryText,
                                time: new Date().toLocaleString()
                            });
                            localStorage.setItem(`summaryRecords_${contactId}`, JSON.stringify(currentRecords));
                            
                            // 如果当前正在查看该角色，更新视图
                            if (currentChatContact.value && currentChatContact.value.id === contactId) {
                                summaryRecords.value = currentRecords;
                            }
                        } catch (e) {
                            console.error('自动总结失败', e);
                        }
                    }
                };

                const deleteSummary = (id) => {
                    if(!confirm('确定删除这条总结吗？')) return;
                    summaryRecords.value = summaryRecords.value.filter(s => s.id !== id);
                    if (currentChatContact.value) {
                        localStorage.setItem(`summaryRecords_${currentChatContact.value.id}`, JSON.stringify(summaryRecords.value));
                    }
                };

                // 其他方法
                const getIconStyle = (type) => {
                    if (settings.value.icons[type]) {
                        return { backgroundImage: `url(${settings.value.icons[type]})` };
                    }
                    return {};
                };

                const getIconPreviewStyle = (type) => {
                    if (tempSettings.value.icons[type]) {
                        return { backgroundImage: `url(${tempSettings.value.icons[type]})` };
                    }
                    return {};
                };

                const updateClock = () => {
                    now.value = new Date();
                };

                const openModal = (type) => {
                    // if (type === 'settings') showSettingsModal.value = true;
                    // if (type === 'api') showApiModal.value = true;
                };

                const closeModal = (type) => {
                    // if (type === 'settings') showSettingsModal.value = false;
                    // if (type === 'api') showApiModal.value = false;
                };

                const handleImageUpload = (event, type) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            cropperImgSrc.value = e.target.result;
                            currentUploadType = type;
                            showCropperModal.value = true;
                            
                            // 重置 input value 以便重复上传同一文件
                            event.target.value = '';

                            nextTick(() => {
                                if (cropperInstance) {
                                    cropperInstance.destroy();
                                }
                                
                                let aspectRatio = NaN;
                                if (type.startsWith('icon-')) {
                                    aspectRatio = 1; // 图标强制 1:1
                                }
                                
                                cropperInstance = new Cropper(cropperImg.value, {
                                    aspectRatio: aspectRatio,
                                    viewMode: 1,
                                    autoCropArea: 1,
                                    background: false
                                });
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                };

                const confirmCrop = () => {
                    if (!cropperInstance) return;
                    
                    const canvas = cropperInstance.getCroppedCanvas();
                    if (!canvas) return;
                    
                    const result = canvas.toDataURL('image/png');
                    
                    try {
                        if (currentUploadType === 'body-bg') {
                            tempSettings.value.bodyBg = result;
                        } else if (currentUploadType === 'calendar-bg') {
                            tempSettings.value.calendarBg = result;
                        } else if (currentUploadType.startsWith('icon-')) {
                            const iconType = currentUploadType.replace('icon-', '');
                            tempSettings.value.icons[iconType] = result;
                        } else if (currentUploadType === 'contact-avatar') {
                            newContact.value.avatar = result;
                        } else if (currentUploadType === 'chat-bg') {
                            chatSettings.value.wallpaper = result;
                        } else if (currentUploadType === 'emoji') {
                            emojis.value.push({
                                id: Date.now(),
                                url: result,
                                desc: '自定义表情'
                            });
                            saveEmojis();
                        }
                    } catch (err) {
                        alert('图片处理出错：' + err.message);
                    }
                    
                    cancelCrop();
                };

                const cancelCrop = () => {
                    showCropperModal.value = false;
                    if (cropperInstance) {
                        cropperInstance.destroy();
                        cropperInstance = null;
                    }
                    cropperImgSrc.value = '';
                    currentUploadType = '';
                };

                const persistCurrentSettings = () => {
                    localStorage.setItem('loveStartDate', settings.value.loveStartDate);
                    
                    if(settings.value.bodyBg) localStorage.setItem('img_body-bg', settings.value.bodyBg);
                    else localStorage.removeItem('img_body-bg');
                    
                    if(settings.value.calendarBg) localStorage.setItem('img_calendar-bg', settings.value.calendarBg);
                    else localStorage.removeItem('img_calendar-bg');
                    
                    ['settings', 'api', 'chat', 'world'].forEach(type => {
                        if(settings.value.icons[type]) localStorage.setItem('img_icon_' + type, settings.value.icons[type]);
                        else localStorage.removeItem('img_icon_' + type);
                    });

                    localStorage.setItem('componentVisibility', JSON.stringify(settings.value.visibility));
                    localStorage.setItem('customGlobalCss', settings.value.customGlobalCss || '');
                };

                const saveSettings = () => {
                    // 将临时设置应用到实际设置
                    settings.value = JSON.parse(JSON.stringify(tempSettings.value));
                    
                    // 应用背景图
                    if(settings.value.bodyBg) document.body.style.backgroundImage = `url(${settings.value.bodyBg})`;
                    else document.body.style.backgroundImage = '';

                    persistCurrentSettings();
                    applyGlobalCss();
                    alert('设置已保存');
                };

                const saveCurrentTheme = () => {
                    if(!newThemeName.value.trim()) {
                        alert('请输入主题名称');
                        return;
                    }
                    
                    const theme = {
                        name: newThemeName.value,
                        settings: JSON.parse(JSON.stringify(tempSettings.value)), // 保存当前编辑状态
                        layout: JSON.parse(JSON.stringify(layout)) // 保存布局
                    };
                    
                    try {
                        const existingIndex = savedThemes.value.findIndex(t => t.name === theme.name);
                        if (existingIndex >= 0) {
                            if(!confirm(`主题 "${theme.name}" 已存在，是否覆盖？`)) return;
                            savedThemes.value[existingIndex] = theme;
                        } else {
                            savedThemes.value.push(theme);
                        }
                        
                        localStorage.setItem('savedThemes', JSON.stringify(savedThemes.value));
                        newThemeName.value = '';
                        alert('主题已保存');
                    } catch (e) {
                        console.error(e);
                        alert('保存失败，可能是图片太大导致存储空间不足。');
                    }
                };

                const applyTheme = (theme) => {
                    if(!confirm(`确定要加载主题 "${theme.name}" 吗？(需要点击保存才能生效)`)) return;
                    
                    tempSettings.value = JSON.parse(JSON.stringify(theme.settings));
                    
                    // 应用布局 (布局暂时保持即时生效，因为不在 tempSettings 中)
                    if (theme.layout) {
                        Object.keys(layout).forEach(key => delete layout[key]);
                        Object.assign(layout, theme.layout);
                        saveLayout();
                    }
                    
                    alert('主题已加载到预览，请点击底部“保存设置”以应用。');
                };

                const removeTheme = (index) => {
                    if(!confirm('确定要删除这个主题吗？')) return;
                    savedThemes.value.splice(index, 1);
                    localStorage.setItem('savedThemes', JSON.stringify(savedThemes.value));
                };

                const resetSettings = () => {
                    if(!confirm('确定要重置当前编辑的设置吗？(需要点击保存才能生效)')) return;
                    
                    tempSettings.value = {
                        loveStartDate: '2026-01-01',
                        bodyBg: '',
                        calendarBg: '',
                        icons: { settings: '', api: '', chat: '', world: '' },
                        visibility: { ...settings.value.visibility }, // 保持可见性设置或重置？通常重置外观不包括可见性，或者全部重置。这里假设重置外观。
                        customGlobalCss: ''
                    };
                    // 补全 visibility 默认值，防止报错
                    tempSettings.value.visibility = {
                        dateBubble: true,
                        calendar: true,
                        love: true,
                        btnSettings: true,
                        btnApi: true,
                        btnChat: true,
                        btnWorld: true
                    };
                    
                    alert('已重置预览，请点击底部“保存设置”以应用。');
                };

                const saveApiSettings = () => {
                    localStorage.setItem('apiEndpoint', api.value.endpoint);
                    localStorage.setItem('apiKey', api.value.key);
                    localStorage.setItem('apiModel', api.value.model);
                    // closeModal('api');
                    alert('API配置已保存');
                };

                const pullGlobalCss = () => {
                    const mainStyle = document.getElementById('main-style');
                    if (mainStyle) {
                        tempSettings.value.customGlobalCss = mainStyle.innerHTML;
                    } else {
                        alert('未找到默认样式代码');
                    }
                };

                // 世界书方法
                const addWorldBook = () => {
                    newWorldItem.value = {
                        id: null,
                        title: '',
                        type: 'book',
                        parentId: currentWorldFolderId.value,
                        cover: '',
                        description: ''
                    };
                    showAddWorldModal.value = true;
                    showWorldMenu.value = false;
                };

                const addWorldGroup = () => {
                    newWorldItem.value = {
                        id: null,
                        title: '',
                        type: 'group',
                        parentId: currentWorldFolderId.value,
                        cover: '',
                        description: ''
                    };
                    showAddWorldModal.value = true;
                    showWorldMenu.value = false;
                };

                const saveWorldItem = () => {
                    if (!newWorldItem.value.title) {
                        alert('请输入标题');
                        return;
                    }

                    if (newWorldItem.value.id) {
                        // 编辑
                        const index = worldList.value.findIndex(i => i.id === newWorldItem.value.id);
                        if (index !== -1) {
                            worldList.value[index] = { ...newWorldItem.value };
                        }
                    } else {
                        // 新增
                        worldList.value.push({
                            ...newWorldItem.value,
                            id: Date.now()
                        });
                    }

                    localStorage.setItem('worldList', JSON.stringify(worldList.value));
                    showAddWorldModal.value = false;
                };

                const handleWorldItemClick = (item) => {
                    if (item.type === 'group') {
                        currentWorldFolderId.value = item.id;
                    } else {
                        // TODO: 打开书籍详情或阅读界面
                        alert('阅读功能开发中: ' + item.title);
                    }
                };

                const handleWorldBack = () => {
                    if (currentWorldFolderId.value) {
                        const currentFolder = worldList.value.find(i => i.id === currentWorldFolderId.value);
                        currentWorldFolderId.value = currentFolder ? currentFolder.parentId : null;
                    } else {
                        currentPage.value = 'home';
                    }
                };

                const startWorldItemLongPress = (event, item) => {
                    if (event.type === 'mousedown' && event.button !== 0) return;
                    isDragging = false; // 防止触发拖动
                    
                    worldItemLongPressTimer = setTimeout(() => {
                        selectedWorldItem.value = item;
                        showWorldActionModal.value = true;
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, 500);
                };

                const endWorldItemLongPress = () => {
                    if (worldItemLongPressTimer) {
                        clearTimeout(worldItemLongPressTimer);
                        worldItemLongPressTimer = null;
                    }
                };

                const editWorldItem = () => {
                    if (!selectedWorldItem.value) return;
                    newWorldItem.value = { ...selectedWorldItem.value };
                    showWorldActionModal.value = false;
                    showAddWorldModal.value = true;
                };

                const deleteWorldItem = () => {
                    if (!selectedWorldItem.value) return;
                    if (confirm(`确定要删除 "${selectedWorldItem.value.title}" 吗？${selectedWorldItem.value.type === 'group' ? '组内内容也会被删除。' : ''}`)) {
                        const deleteIds = [selectedWorldItem.value.id];
                        // 如果是组，递归查找所有子项ID
                        if (selectedWorldItem.value.type === 'group') {
                            const findChildren = (parentId) => {
                                const children = worldList.value.filter(i => i.parentId === parentId);
                                children.forEach(c => {
                                    deleteIds.push(c.id);
                                    if (c.type === 'group') findChildren(c.id);
                                });
                            };
                            findChildren(selectedWorldItem.value.id);
                        }

                        worldList.value = worldList.value.filter(i => !deleteIds.includes(i.id));
                        localStorage.setItem('worldList', JSON.stringify(worldList.value));
                    }
                    showWorldActionModal.value = false;
                };

                const applyGlobalCss = () => {
                    let styleTag = document.getElementById('user-global-css');
                    if (!styleTag) {
                        styleTag = document.createElement('style');
                        styleTag.id = 'user-global-css';
                        document.head.appendChild(styleTag);
                    }
                    styleTag.innerHTML = settings.value.customGlobalCss || '';
                };

                const loadData = () => {
                    settings.value.loveStartDate = localStorage.getItem('loveStartDate') || '2026-01-01';
                    
                    const bodyBg = localStorage.getItem('img_body-bg');
                    if (bodyBg) {
                        settings.value.bodyBg = bodyBg;
                        document.body.style.backgroundImage = `url(${bodyBg})`;
                    }

                    const calBg = localStorage.getItem('img_calendar-bg');
                    if (calBg) {
                        settings.value.calendarBg = calBg;
                    }

                    ['settings', 'api', 'chat', 'world'].forEach(type => {
                        const iconData = localStorage.getItem('img_icon_' + type);
                        if (iconData) {
                            settings.value.icons[type] = iconData;
                        }
                    });

                    try {
                        const savedVisibility = localStorage.getItem('componentVisibility');
                        if (savedVisibility) {
                            const parsed = JSON.parse(savedVisibility);
                            settings.value.visibility = { ...settings.value.visibility, ...parsed };
                        }
                    } catch (e) {
                        console.error('加载组件可见性设置失败', e);
                    }

                    const savedGlobalCss = localStorage.getItem('customGlobalCss');
                    if (savedGlobalCss) {
                        settings.value.customGlobalCss = savedGlobalCss;
                        applyGlobalCss();
                    }

                    api.value.endpoint = localStorage.getItem('apiEndpoint') || '';
                    api.value.key = localStorage.getItem('apiKey') || '';
                    api.value.model = localStorage.getItem('apiModel') || '';

                    try {
                        const themes = localStorage.getItem('savedThemes');
                        if (themes) savedThemes.value = JSON.parse(themes);
                    } catch(e) {
                        console.error('加载主题失败', e);
                    }

                    // 加载布局
                    try {
                        const savedLayout = localStorage.getItem('customLayout');
                        if (savedLayout) {
                            Object.assign(layout, JSON.parse(savedLayout));
                        }
                    } catch(e) {
                        console.error('加载布局失败', e);
                    }

                    // 加载通讯录
                    try {
                        const savedContacts = localStorage.getItem('contacts');
                        if (savedContacts) {
                            contacts.value = JSON.parse(savedContacts);
                        }
                    } catch(e) {
                        console.error('加载通讯录失败', e);
                    }

                    // 加载聊天记录
                    try {
                        const savedMessages = localStorage.getItem('chatMessages');
                        if (savedMessages) {
                            chatMessages.value = JSON.parse(savedMessages);
                        }
                    } catch(e) {
                        console.error('加载聊天记录失败', e);
                    }

                    // 加载表情包
                    try {
                        const savedEmojis = localStorage.getItem('emojis');
                        if (savedEmojis) {
                            emojis.value = JSON.parse(savedEmojis);
                        } else {
                            // 默认表情包示例
                            emojis.value = [
                                { id: 1, url: 'https://api.iconify.design/twemoji:grinning-face.svg', desc: '笑脸' },
                                { id: 2, url: 'https://api.iconify.design/twemoji:red-heart.svg', desc: '爱心' },
                                { id: 3, url: 'https://api.iconify.design/twemoji:thumbs-up.svg', desc: '点赞' }
                            ];
                        }
                    } catch(e) {
                        console.error('加载表情包失败', e);
                    }

                    // 加载世界书
                    try {
                        const savedWorldList = localStorage.getItem('worldList');
                        if (savedWorldList) {
                            worldList.value = JSON.parse(savedWorldList);
                        }
                    } catch(e) {
                        console.error('加载世界书失败', e);
                    }
                };

                onMounted(() => {
                    loadData();
                    timer = setInterval(updateClock, 1000);
                    
                    // 全局事件监听
                    window.addEventListener('mousemove', handleMove);
                    window.addEventListener('mouseup', endDrag);
                    window.addEventListener('touchmove', handleMove, { passive: false });
                    window.addEventListener('touchend', endDrag);
                });

                onUnmounted(() => {
                    if (timer) clearInterval(timer);
                    window.removeEventListener('mousemove', handleMove);
                    window.removeEventListener('mouseup', endDrag);
                    window.removeEventListener('touchmove', handleMove);
                    window.removeEventListener('touchend', endDrag);
                });

                return {
                    now,
                    // showSettingsModal,
                    // showApiModal,
                    showWorldMenu,
                    worldList,
                    currentWorldFolderId,
                    currentWorldItems,
                    currentWorldFolderName,
                    showAddWorldModal,
                    showWorldActionModal,
                    newWorldItem,
                    selectedWorldItem,
                    addWorldBook,
                    addWorldGroup,
                    saveWorldItem,
                    handleWorldItemClick,
                    handleWorldBack,
                    startWorldItemLongPress,
                    endWorldItemLongPress,
                    editWorldItem,
                    deleteWorldItem,
                    settings,
                    tempSettings,
                    api,
                    availableModels,
                    isLoadingModels,
                    fetchModels,
                    currentTime,
                    currentDateShort,
                    currentWeek,
                    currentDateFull,
                    loveDays,
                    calendarStyle,
                    previewBodyBgStyle,
                    previewCalendarBgStyle,
                    openModal,
                    closeModal,
                    handleImageUpload,
                    saveSettings,
                    saveApiSettings,
                    getIconStyle,
                    getIconPreviewStyle,
                    savedThemes,
                    newThemeName,
                    saveCurrentTheme,
                    applyTheme,
                    removeTheme,
                    resetSettings,
                    // 拖动相关
                    mainScreen,
                    draggingId,
                    getLayoutStyle,
                    startDrag,
                    handleClick,
                    resetLayout,
                    // 裁剪相关
                    showCropperModal,
                    cropperImgSrc,
                    cropperImg,
                    confirmCrop,
                    cancelCrop,
                    // 聊天相关
                    currentPage,
                    chatTab,
                    chatPageTitle,
                    contacts,
                    showAddContactModal,
                    newContact,
                    openAddContactModal,
                    saveContact,
                    // 长按编辑相关
                    showActionModal,
                    startContactLongPress,
                    endContactLongPress,
                    editContact,
                    deleteContact,
                    editingContactId,
                    // 聊天详情页
                    currentChatContact,
                    chatInputMessage,
                    showChatExtras,
                    currentExtraView,
                    showVoiceModal,
                    voiceInputText,
                    showPhotoModal,
                    photoInputText,
                    albumUpload,
                    handleAlbumUpload,
                    emojis,
                    toggleChatExtras,
                    handleExtraAction,
                    handleSendVoice,
                    handleSendPhoto,
                    addEmojiFromUrl,
                    deleteEmoji,
                    sendEmoji,
                    toggleVoiceText,
                    togglePhotoText,
                    showChatSettingsModal,
                    chatMessages,
                    chatSettings,
                    openChat,
                    closeChat,
                    sendMessage,
                    handleSendClick,
                    saveChatSettings,
                    pullDefaultCss,
                    showSummarySettingsModal,
                    summaryRecords,
                    manualSummaryRange,
                    isSummarizing,
                    performManualSummary,
                    deleteSummary,
                    // 消息操作
                    showMsgActionModal,
                    selectedMsg,
                    replyingMsg,
                    startMsgLongPress,
                    endMsgLongPress,
                    handleMsgAction,
                    showEditMsgModal,
                    editMsgInputText,
                    handleSaveEditedMsg,
                    toggleRecalledContent,
                    // 全局CSS
                    pullGlobalCss
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
